<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">
  <meta name="google-site-verification" content="lhV5cabuw1R5ZNw3egkRBdP3yiHpIpX4_8SvcqwxYAc">
  <meta name="baidu-site-verification" content="code-abAwAH8nFB">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ylab324.github.io","root":"/","images":"/images","scheme":"Gemini","version":"8.5.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>
<meta name="description" content="理解不深，尽量记录扫台流程关于si的部分，免得以后又重新看。">
<meta property="og:type" content="article">
<meta property="og:title" content="扫台2">
<meta property="og:url" content="https://ylab324.github.io/2021/10/20/scan-si/">
<meta property="og:site_name" content="Debbie">
<meta property="og:description" content="理解不深，尽量记录扫台流程关于si的部分，免得以后又重新看。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">
<meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f525.png?v8">
<meta property="og:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8">
<meta property="article:published_time" content="2021-10-20T01:15:13.000Z">
<meta property="article:modified_time" content="2025-07-10T15:15:49.268Z">
<meta property="article:author" content="ylab324">
<meta property="article:tag" content="tv">
<meta property="article:tag" content="dvb">
<meta property="article:tag" content="si">
<meta property="article:tag" content="2851">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">


<link rel="canonical" href="https://ylab324.github.io/2021/10/20/scan-si/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ylab324.github.io/2021/10/20/scan-si/","path":"2021/10/20/scan-si/","title":"扫台2"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>扫台2 | Debbie</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Debbie</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">所记更为简略，系备忘性质。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#si-agent-threadfuntion"><span class="nav-number">1.</span> <span class="nav-text">si_agent_threadfuntion</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SI-AGENT-STATUS-STOPPED"><span class="nav-number">1.1.</span> <span class="nav-text">SI_AGENT_STATUS_STOPPED</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#xWorkerThread-CH-SCAN-STATE-INIT"><span class="nav-number">1.1.1.</span> <span class="nav-text">xWorkerThread CH_SCAN_STATE_INIT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND"><span class="nav-number">1.1.2.</span> <span class="nav-text">RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunStateProc-FREQ-SCAN-STATE-CHECK-SI"><span class="nav-number">1.1.3.</span> <span class="nav-text">RunStateProc FREQ_SCAN_STATE_CHECK_SI</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SI-AGENT-STATUS-RUNNING"><span class="nav-number">1.2.</span> <span class="nav-text">SI_AGENT_STATUS_RUNNING</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RunStateProc-FREQ-SCAN-STATE-CHECK-SI-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">RunStateProc FREQ_SCAN_STATE_CHECK_SI</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SDEC-Thread"><span class="nav-number">2.</span> <span class="nav-text">_SDEC_Thread</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ylab324"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">ylab324</p>
  <div class="site-description" itemprop="description">All I want out of life is a bit of peace and happiness. That's all.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">77</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">96</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="mailto:logbang@gmail.com" title="E-Mail → mailto:logbang@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



          </div>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ylab324.github.io/2021/10/20/scan-si/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="ylab324">
      <meta itemprop="description" content="All I want out of life is a bit of peace and happiness. That's all.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Debbie">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          扫台2
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-20 09:15:13" itemprop="dateCreated datePublished" datetime="2021-10-20T09:15:13+08:00">2021-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/TV/" itemprop="url" rel="index"><span itemprop="name">TV</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>理解不深，尽量记录扫台流程关于si的部分，免得以后又重新看。</p>
<span id="more"></span>

<p>结合上篇<a href="https://ylab324.github.io/2021/09/16/scan/">《扫台》</a>，直接从ScanThread线程xWorkerThread状态机看起。</p>
<h2 id="si-agent-threadfuntion"><a href="#si-agent-threadfuntion" class="headerlink" title="si_agent_threadfuntion"></a>si_agent_threadfuntion</h2><h3 id="SI-AGENT-STATUS-STOPPED"><a href="#SI-AGENT-STATUS-STOPPED" class="headerlink" title="SI_AGENT_STATUS_STOPPED"></a>SI_AGENT_STATUS_STOPPED</h3><h4 id="xWorkerThread-CH-SCAN-STATE-INIT"><a href="#xWorkerThread-CH-SCAN-STATE-INIT" class="headerlink" title="xWorkerThread CH_SCAN_STATE_INIT"></a>xWorkerThread CH_SCAN_STATE_INIT</h4><p>关注CH_SCAN_STATE_INIT这个case，跑了xStageInit()这个函数：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Channel/Scan/TableScanner.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CTableScanner::xStageInit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 省略代码段</span></span><br><span class="line">    m_pFreqScanDetector-&gt;<span class="built_in">Mf_ScanInit</span>(scanMode, param, m_bDelNosignalMux,scanModeEx);</span><br><span class="line">    <span class="comment">// 省略代码段</span></span><br><span class="line">    m_scanState = CH_SCAN_STATE_BEGIN_FREQ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Channel/Scan/DtvFreqDetector.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CDtvFreqDetector::Mf_ScanInit</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CH_SCAN_MODE scanMode,</span></span></span><br><span class="line"><span class="params"><span class="function">    UINT32 param,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">bool</span> bDelNoSignalMux,</span></span></span><br><span class="line"><span class="params"><span class="function">    CH_SCAN_MODE_EX modeEx</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// 省略代码段</span></span><br><span class="line">    pDtvFlow-&gt;<span class="built_in">PrepareAutoScanFlow</span>();</span><br><span class="line">    <span class="comment">// 省略代码段</span></span><br><span class="line">    m_pIDtvMedia-&gt;<span class="built_in">GetSiMgr</span>()-&gt;<span class="built_in">ScanInit</span>(<span class="built_in">getSiScanType</span>(scanMode), param, typeEx);</span><br><span class="line">    <span class="comment">// 省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* DriverBasedDtvApp/DriverBasedDtvApp.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DriverBasedDtvApp::PrepareAutoScanFlow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">"[%s %s %d]\n"</span>,__FILE__, __func__, __LINE__);</span><br><span class="line">	<span class="comment">//Q: need to stop VDEC and ADEC if they are present?</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">OpenSdec</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可见扫台前有个OpenSdec的动作，Sdec是System Decoder的意思（类似的还有用Vdec和Adec分别表示Video Decoder、Audio Decoder）。</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* DriverBasedDtvApp/DriverBasedDtvApp.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DriverBasedDtvApp::OpenSdec</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">if</span>(m_sdec &lt; SDEC_CH_MAX)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> index = <span class="built_in">RHAL_SDEC_AcquireChannel</span>(<span class="string">"DTV_LIVE"</span>, SDEC_CH_PVR_ONLY);</span><br><span class="line">	<span class="keyword">if</span>(index &lt; <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"[%s %d] fail to acquire SDEC\n"</span>, __func__, __LINE__);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	m_sdec = (SDEC_CHANNEL_T)index;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ALOGD</span>(<span class="string">"[%s %d]  m_sdec = %d\n"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">	m_sdecSrc = (m_sdec == SDEC_CH_A) ? HAL_AUDIO_RESOURCE_SDEC0 : HAL_AUDIO_RESOURCE_SDEC1;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">RHAL_SDEC_InitChannel</span>(m_sdec) != API_OK)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"[%s %d] ERROR : RHAL_SDEC_InitChannel fails. m_sdec = %d"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">RHAL_SDEC_SetBufferOwner</span>(m_sdec, SDEC_KERNEL_DRIVER) != API_OK)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"[%s %d] ERROR : RHAL_SDEC_Run fails. m_sdec = %d"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="built_in">ALOGD</span>(<span class="string">"[%s %d] Set RHAL_SDEC_EnableTimeStampPadding. m_sdec = %d"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">RHAL_SDEC_EnableTimeStampPadding</span>(m_sdec, <span class="literal">true</span>) != API_OK)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"[%s %d] ERROR : RHAL_SDEC_EnableTimeStampPadding fails. m_sdec = %d"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">RHAL_SDEC_Run</span>(m_sdec) != API_OK)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"[%s %d] ERROR : RHAL_SDEC_Run fails. m_sdec = %d"</span>, __func__, __LINE__, m_sdec);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">SetSdecInputConfig</span>())</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(m_pSiInterface == <span class="number">0</span>)</span><br><span class="line">		m_pSiInterface = <span class="keyword">new</span> <span class="built_in">CSiInterface</span>(<span class="keyword">this</span>, m_tvsystem);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(m_pSiInterface)</span><br><span class="line">	{</span><br><span class="line">		m_pSiInterface-&gt;<span class="built_in">InitSiEngine</span>(m_sdec, m_siHandle);</span><br><span class="line">		<span class="comment">// ConnectAudio to decide audio preiview on</span></span><br><span class="line">		<span class="built_in">ALOGD</span>(<span class="string">"[%s %d] Set audio preview on first, AudioPreviewOn: %d\n"</span>, __func__, __LINE__, m_status.bIsAudioPreviewOn);</span><br><span class="line">		m_pSiInterface-&gt;<span class="built_in">SetAudioPreviewMode</span>(m_status.bIsAudioPreviewOn);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后InitSiEngine，Engine是用来干嘛的？理解不足，名字就像做一些si管理统筹工作的，然后siEngineOut、m_siEngineIn做一些状态更新，发消息等的信息输入输出：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* DriverBasedDtvApp/CSiInterface.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CSiInterface::InitSiEngine</span><span class="params">(SDEC_CHANNEL_T sdec, <span class="keyword">unsigned</span> <span class="keyword">int</span> siHandle)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	SI_ENGINE_OUT siEngineOut;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	siEngineOut.InsertFilterList   = insertFilterList;</span><br><span class="line">	siEngineOut.RemoveFilterList   = removeFilterList;</span><br><span class="line">	siEngineOut.RemoveAllFilters   = removeAllFilters;</span><br><span class="line">	siEngineOut.SetActiveComponent = setActiveComponent;</span><br><span class="line">	siEngineOut.PostEvent		  = postEvent;</span><br><span class="line">	siEngineOut.SetSiState		 = setSiState;</span><br><span class="line">	siEngineOut.CheckScramble	   = checkScramble;</span><br><span class="line">	siEngineOut.ResetPosition	  = resetPosition;</span><br><span class="line">	siEngineOut.FeedbackPrivateInfo = feedbackPrivateInfo;</span><br><span class="line">	siEngineOut.GetPIDByFilterType  = getPIDByFilterType;<span class="comment">//#ifdef ENABLE_MHEG5</span></span><br><span class="line">	m_siHandle = siHandle;</span><br><span class="line">	m_sdec = sdec;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(&amp;m_siEngineIn, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(m_siEngineIn));</span><br><span class="line">	<span class="keyword">if</span> (m_tvSystem== RT_TV_SYSTEM_ATSC){</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ATSC_T</span></span><br><span class="line">		ret = <span class="built_in">AttachSiAtscEngine</span>((<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="keyword">this</span>, &amp;siEngineOut, m_siHandle, &amp;m_siEngineIn);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (m_tvSystem==RT_TV_SYSTEM_DVB){</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DVB_T</span></span><br><span class="line">		ret = <span class="built_in">AttachSiEngine</span>((<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="keyword">this</span>, &amp;siEngineOut, m_siHandle, &amp;m_siEngineIn);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"%s_%d: unknown tvsystem, fail to InitSiEngine\n"</span>, __func__, __LINE__);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span>(ret == <span class="number">1</span>)</span><br><span class="line">	{</span><br><span class="line">		m_siEngineIn.<span class="built_in">SetSdecCh</span>(siHandle, (<span class="keyword">int</span>)m_sdec);</span><br><span class="line">		m_bSiEngineAttached = <span class="literal">true</span>;</span><br><span class="line">		<span class="built_in">RemoveAllFilters</span>();</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">ALOGE</span>(<span class="string">"%s_%d: unknown tvsystem, fail to InitSiEngine\n"</span>, __func__, __LINE__);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> m_bSiEngineAttached;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/tpInterface/PVR/siEngine.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">AttachSiEngine</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>   navHandle,    <span class="comment">/* IN:  handle of the nav outside */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    SI_ENGINE_OUT* pSiEngineOut, <span class="comment">/* IN:  outgoing interface for SI engine */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>   siHandle,     <span class="comment">/* IN:  handle of the SI engine */</span></span></span></span><br><span class="line"><span class="params"><span class="function">    SI_ENGINE_IN*  pSiEngineIn   <span class="comment">/* OUT: incoming interface for SI engine */</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">void</span> *tp1, *tp2;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pSiEngineOut || !pSiEngineIn || !siHandle)</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line"></span><br><span class="line">    SI_Get_TP((SI*)siHandle, &amp;tp1);</span><br><span class="line"></span><br><span class="line">    SI_TPInterface_New(&amp;tp2, navHandle, (<span class="keyword">void</span>*)pSiEngineOut</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_USE_SDEC</span></span><br><span class="line">                       ,siHandle,SDEC_CH_MAX</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                      );</span><br><span class="line"></span><br><span class="line">    SI_Set_TP((SI*)siHandle, tp2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(tp1)</span><br><span class="line">    {</span><br><span class="line">        SI_TPInterface_Destroy(&amp;tp1);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functions for TS engine to call upon.</span></span><br><span class="line">    pSiEngineIn-&gt;StoreSiPacket	= SI_PVRInterface_StorePackets;</span><br><span class="line">    pSiEngineIn-&gt;StoreSiState	= SI_PVRInterface_StoreSiState;</span><br><span class="line">    pSiEngineIn-&gt;Flush			= SI_PVRInterface_Flush;</span><br><span class="line">    pSiEngineIn-&gt;GetBufferLength= SI_GetRingBufferLength;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_USE_SDEC</span></span><br><span class="line">    pSiEngineIn-&gt;SetSdecCh			= SetSdecCh;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> FEATURE_001</span></span><br><span class="line">    pSiEngineIn-&gt;GetPAT			= <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// FEATURE_001	</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/api/SI_Api.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Set_TP</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI									*pSI,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span>								*tp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_API_BEGIN();</span><br><span class="line">    SI_ASSERT(pSI);</span><br><span class="line"></span><br><span class="line">    pSI-&gt;tp = tp;</span><br><span class="line">    pSI-&gt;collector-&gt;tp = tp;</span><br><span class="line">    SI_Agent_New(&amp;pSI-&gt;agent, pSI, pSI-&gt;db, pSI-&gt;collector, pSI-&gt;tp);</span><br><span class="line"></span><br><span class="line">    SI_API_RETURN(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这个SI_Agent_New还挺长，先记一点关键的，这个Agent的概念又该怎么理解呢？不懂：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/SI_Agent.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Agent_New</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_AGENT							**ppAgent,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI									*pSI,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_DATABASE							*pDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_COLLECTOR						*pCollector,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span>								*pTPHandle</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    agent-&gt;agentObjHandle = (<span class="keyword">void</span>*)SiAgtIF_CreateSiAgentObject(<span class="string">"UND"</span>, pSI, pDatabase, pTPHandle);</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    agent-&gt;status = SI_AGENT_STATUS_STOPPED;</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    SiAgtIF_RegisterCBF(agent-&gt;agentObjHandle, SI_Callback_ScanChannel, SI_AGENT_CBF_TYPE_SCAN_CHANNEL);</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    pthread_create(&amp;__agentThread, <span class="literal">NULL</span>, (<span class="keyword">void</span>*)&amp;si_agent_threadfuntion, <span class="literal">NULL</span>);</span><br><span class="line">     <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里要分3部分看：</p>
<ul>
<li><p>SiAgtIF_CreateSiAgentObject</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentInterface.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">SIAGENT_OBJECT_P <span class="title">SiAgtIF_CreateSiAgentObject</span><span class="params">( <span class="keyword">char</span>* pAgentObjectName, SI_HANDLE si, SIDB_HANDLE handleSidb, DEMUXER_HANDLE handleDemuxer )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> SiAgent_CreateSiAgentObject( pAgentObjectName, si, handleSidb, handleDemuxer );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentObject.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">SIAGENT_OBJECT_P <span class="title">SiAgent_CreateSiAgentObject</span><span class="params">( <span class="keyword">char</span>* pAgentObjectName, SI_HANDLE si, SIDB_HANDLE handleSidb, DEMUXER_HANDLE handleDemuxer )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line"><span class="comment">//Private Method:</span></span><br><span class="line">    pSiAgentObj-&gt;ExecMainTaskSM = SiAgentObj_ExecMainTaskSM ;</span><br><span class="line">    pSiAgentObj-&gt;ExecSubTaskSM = SiAgentObj_ExecSubTaskSM ;</span><br><span class="line">    pSiAgentObj-&gt;CheckSubTaskInQueue = SiAgentObj_CheckSubTaskInQueue ;</span><br><span class="line">    pSiAgentObj-&gt;GetSubTaskFromQueue = SiAgentObj_GetSubTaskFromQueue ;</span><br><span class="line">    pSiAgentObj-&gt;CheckMainTaskInQueue = SiAgentObj_CheckMainTaskInQueue ;</span><br><span class="line">    pSiAgentObj-&gt;GetMainTaskFromQueue = SiAgentObj_GetMainTaskFromQueue ;</span><br><span class="line"><span class="comment">//Public Method:</span></span><br><span class="line">    pSiAgentObj-&gt;GetSidbHandle = SiAgentObj_GetSidbHandle ;</span><br><span class="line">    pSiAgentObj-&gt;GetObjectId = SiAgentObj_GetObjectId ;</span><br><span class="line">    pSiAgentObj-&gt;Run = SiAgentObj_Run ;</span><br><span class="line">    pSiAgentObj-&gt;CheckAllSmIdle = SiAgentObj_CheckAllSmIdle ;</span><br><span class="line">    pSiAgentObj-&gt;InsertMainTaskIntoQueue = SiAgentObj_InsertMainTaskIntoQueue ;</span><br><span class="line">    pSiAgentObj-&gt;StopAllTask = SiAgentObj_StopAllTask ;</span><br><span class="line">    pSiAgentObj-&gt;RegisterCBF = SiAgentObj_RegisterCBF ;</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里主要是设置SiAgentObject的一些方法，比如Run、ExecMainTaskSM等，后面会用到。</p>
</li>
<li><p>SI_Callback_ScanChannel</p>
<p>设置回调，后面会用到：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/api/SI_Api.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">SI_Callback_ScanChannel</span><span class="params">(SI *si, <span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_DATABASE_TS_NODE *ts = (SI_DATABASE_TS_NODE*)arg;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//kjw note: SI_STATE_AUTOSCAN has thread issue. Beware it if someone modify the code in the future!</span></span><br><span class="line">    <span class="keyword">if</span>( SI_HAS_STATE(si-&gt;state, SI_STATE_AUTOSCAN)  ) {</span><br><span class="line"></span><br><span class="line">        <span class="comment">//to update scanned ch count for AP</span></span><br><span class="line">        <span class="keyword">if</span>( ts != <span class="literal">NULL</span>) {</span><br><span class="line">            <span class="keyword">if</span>(!(SI_HAS_STATE(si-&gt;state, SI_STATE_UPDATE)&amp;&amp;ts-&gt;strength==(MANUAL_SCAN_STRENGTH-STRENGTH_DIFF_THRESHOLD)))<span class="comment">//keep manual scan service in high priority for update scan</span></span><br><span class="line">            {</span><br><span class="line">                ts-&gt;strength=si-&gt;strength;</span><br><span class="line">                ts-&gt;snr=(<span class="keyword">unsigned</span> <span class="keyword">short</span>)(si-&gt;snr*<span class="number">100</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"\033[1;31m %s=&gt;freq: %d, strength:%d ,snr:%d \033 [m\n"</span>,__FUNCTION__,ts-&gt;frequency,ts-&gt;strength,ts-&gt;snr);</span><br><span class="line">            SI_Channel_UpdateChList_Append(si-&gt;chMgr, si-&gt;db, ts,<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_NEW_DVB</span></span><br><span class="line">            <span class="keyword">if</span>(IS_SUPPORT_TRD(si))</span><br><span class="line">            {</span><br><span class="line">                si_BuildTRD(si,ts);</span><br><span class="line">            }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {   <span class="comment">//manual scan(tuner or file playback scan)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( ts != <span class="literal">NULL</span>) {</span><br><span class="line">            si_channel_updatePartialChList(si-&gt;chMgr, si-&gt;db, ts-&gt;frequency,FALSE,FALSE,FALSE,SI_TID_ALL);</span><br><span class="line">            ts-&gt;snr=ts-&gt;strength=MANUAL_SCAN_STRENGTH-STRENGTH_DIFF_THRESHOLD;<span class="comment">//best mux, manual scan is high priority</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {   <span class="comment">//no PAT or PMT</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//if(SI_IS_MONITOR_NETWORK_SDT(si))</span></span><br><span class="line">    <span class="keyword">if</span>(ts!=<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(SI_IS_ADD_CH_IN_NO_SDT(si))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">int</span> Tv=<span class="number">1</span>,Radio=<span class="number">1</span>,Data=<span class="number">1</span>;</span><br><span class="line">            SI_CHANNEL_EXT *_ch;</span><br><span class="line">            _ch = si-&gt;chMgr-&gt;chList;</span><br><span class="line">            <span class="keyword">while</span>(_ch)</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span>(_ch-&gt;oriChannelNameLen == <span class="number">0</span>)</span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">if</span>( get_ServiceType(si,_ch-&gt;serviceType)==SI_DVB_SERVICE_DTV)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="built_in">snprintf</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName,SI_CH_CHANNELNAME_MAXLEN<span class="number">-1</span>,<span class="string">"TV %d"</span>,Tv);</span><br><span class="line">                        _ch-&gt;super.channelNameLen=<span class="built_in">strlen</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName);</span><br><span class="line">                        Tv++;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>( get_ServiceType(si,_ch-&gt;serviceType)==SI_DVB_SERVICE_RADIO)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="built_in">snprintf</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName,SI_CH_CHANNELNAME_MAXLEN<span class="number">-1</span>,<span class="string">"Radio %d"</span>,Radio);</span><br><span class="line">                        _ch-&gt;super.channelNameLen=<span class="built_in">strlen</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName);</span><br><span class="line">                        Radio++;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span>( get_ServiceType(si,_ch-&gt;serviceType)==SI_DVB_SERVICE_DATA)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="built_in">snprintf</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName,SI_CH_CHANNELNAME_MAXLEN<span class="number">-1</span>,<span class="string">"Data %d"</span>,Data);</span><br><span class="line">                        _ch-&gt;super.channelNameLen=<span class="built_in">strlen</span>((<span class="keyword">char</span>*)_ch-&gt;super.channelName);</span><br><span class="line">                        Data++;</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                }</span><br><span class="line">                _ch = _ch-&gt;next;</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//省略代码动态</span></span><br><span class="line"></span><br><span class="line">    SiMessage_Store(&amp;si-&gt;mq, SI_MESSAGE_CH_INFO_READY,</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0<span class="comment">//def FIX_DTV_LABS_HK_ISSUE_48</span></span></span><br><span class="line">                    pDupLcnList</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    arg == <span class="literal">NULL</span> ? <span class="number">1</span> : <span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                   );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>si_agent_threadfuntion</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/SI_Agent.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">si_agent_threadfuntion</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_AGENT_LIST_NODE *agentNode;</span><br><span class="line">    SI_AGENT *agent=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">//int checkSize=0,sleepCount=0, countDown = 0;</span></span><br><span class="line">    <span class="comment">//not more than 100ms.</span></span><br><span class="line">    <span class="comment">//stream may be 4MB/s.</span></span><br><span class="line">    <span class="comment">//checkSize=64*188;//almost=&gt;(4*1024*1024)*3/10/10/10;</span></span><br><span class="line">    pthread_setname_np(pthread_self(), __FUNCTION__);</span><br><span class="line">    <span class="keyword">while</span>(!__stopAgentThread)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">//sleepCount=0;</span></span><br><span class="line">        pthread_mutex_lock(&amp;__agentListMutex);</span><br><span class="line">        agentNode = __agentList;</span><br><span class="line">        <span class="keyword">while</span>(agentNode)</span><br><span class="line">        {</span><br><span class="line">            agent = agentNode-&gt;agent;</span><br><span class="line">            agentNode = agentNode-&gt;next;</span><br><span class="line">            SI_Agent_CollectSection(agent);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Split SI_SLEEP(30) to 3 times to avoid overflowing while huge data comes</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            countDown = 3 ;</span></span><br><span class="line"><span class="comment">            while(countDown--)</span></span><br><span class="line"><span class="comment">            {</span></span><br><span class="line"><span class="comment">                if (agent &amp;&amp; !__stopAgentThread &amp;&amp; sleepCount&lt;3 &amp;&amp;</span></span><br><span class="line"><span class="comment">                        SI_PVRTP_GetRingBufferLength((unsigned int)agent-&gt;tp)&lt;checkSize) {</span></span><br><span class="line"><span class="comment">                    SI_SLEEP(10);</span></span><br><span class="line"><span class="comment">                    sleepCount++;</span></span><br><span class="line"><span class="comment">                }</span></span><br><span class="line"><span class="comment">            }*/</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;__agentListMutex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sleep to context switch while SI_Agent_New blocked on mutex</span></span><br><span class="line">        <span class="comment">//if (sleepCount)</span></span><br><span class="line">        {</span><br><span class="line">            SI_SLEEP(<span class="number">10</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>主要看SI_Agent_CollectSection这个：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/SI_Agent.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">SI_Agent_CollectSection</span><span class="params">(SI_AGENT *agent)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    BOOL stopped;</span><br><span class="line">    <span class="keyword">if</span> (agent==<span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;agent-&gt;mutexCollect);</span><br><span class="line">    <span class="keyword">if</span>(agent-&gt;waitingForReset == TRUE)</span><br><span class="line">    {</span><br><span class="line">        SI_Collector_Reset(agent-&gt;collector,TRUE,TRUE);</span><br><span class="line">        agent-&gt;waitingForReset=FALSE;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">if</span>(agent-&gt;status == SI_AGENT_STATUS_TO_STOP)</span><br><span class="line">        {</span><br><span class="line">            stopped = FALSE;</span><br><span class="line">            <span class="keyword">while</span>(!stopped)</span><br><span class="line">            {</span><br><span class="line">                SiAgtIF_Run(agent-&gt;agentObjHandle);<span class="comment">//close all filter</span></span><br><span class="line">                SiAgtIF_CheckAllSmIdle(agent-&gt;agentObjHandle, &amp;stopped);</span><br><span class="line">            }</span><br><span class="line">            agent-&gt;status = SI_AGENT_STATUS_STOPPED;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(agent-&gt;status == SI_AGENT_STATUS_RUNNING)</span><br><span class="line">        {</span><br><span class="line">            SiAgtIF_Run(agent-&gt;agentObjHandle);</span><br><span class="line">            SI_Collector_CollectSection(agent-&gt;collector, agent-&gt;db, agent-&gt;tp);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    pthread_mutex_unlock(&amp;agent-&gt;mutexCollect);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>刚才SI_Agent_New的时候，已经把SI_AGENT_STATUS状态设定为SI_AGENT_STATUS_STOPPED，所以现在si_agent_threadfuntion这个线程里，基本是卡住了的。</p>
</li>
</ul>
<p>至此，CH_SCAN_STATE_INIT阶段结束了，紧跟着的CH_SCAN_STATE_BEGIN_FREQ阶段没有si相关的内容，可以跳过，接着来到CH_SCAN_STATE_SCANNING阶段。</p>
<h4 id="RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND"><a href="#RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND" class="headerlink" title="RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND"></a>RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND</h4><p>函数xStageCheckFrontend如下：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Channel/Scan/DtvFreqDetector.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CDtvFreqDetector::xStageCheckFrontend</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    m_pIDtvMedia-&gt;<span class="built_in">GetSiMgr</span>()-&gt;<span class="built_in">ScanStart</span>(m_curFreq, m_modulation, m_curBandwidth, symbolrate,  m_curPhyChNum, tuner-&gt;<span class="built_in">getRFStrength</span>(), tuner-&gt;<span class="built_in">getSignalSNR</span>(), m_serviceID);</span><br><span class="line">    </span><br><span class="line">    m_scanState = FREQ_SCAN_STATE_CHECK_SI;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Si/DvbSiMgr.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CDvbSiMgr::ScanStart</span><span class="params">(UINT32 frequency, RT_MODULATION modulation, UINT32 bandwidth, UINT32 symbolrate, UINT32 phyChNum,UINT32 strength,<span class="keyword">float</span> snr, UINT16 serviceID)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI* siHandle = (SI*)m_pTvMedia-&gt;<span class="built_in">GetDtvFlow</span>()-&gt;<span class="built_in">GetSiHandle</span>();</span><br><span class="line">    SI_DVB_MODULATION siModulation;</span><br><span class="line"></span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span>(modulation)</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> RT_MOD_QAM16:</span><br><span class="line">        siModulation=SI_DVB_16_QAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RT_MOD_QAM32:</span><br><span class="line">        siModulation=SI_DVB_32_QAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RT_MOD_QAM64:</span><br><span class="line">        siModulation=SI_DVB_64_QAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RT_MOD_QAM128:</span><br><span class="line">        siModulation=SI_DVB_128_QAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">case</span> RT_MOD_QAM256:</span><br><span class="line">        siModulation=SI_DVB_256_QAM;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SI_SetState</span>(siHandle, SI_STATE_SCAN);</span><br><span class="line">    <span class="built_in">SI_ScanChannelEx</span>(siHandle, frequency, <span class="number">0</span>, bandwidth,siModulation,symbolrate, strength,snr,serviceID,(<span class="keyword">unsigned</span> <span class="keyword">char</span>)phyChNum);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/api/SI_Api.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_ScanChannelEx</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI									*pSI,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						frequency,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span>									offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						bandwidth,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span>						modulation,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span> 						symbolrate,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						strength,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span>							snr,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">short</span> serviceID,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span> phyChNum</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//force agent to start.</span></span><br><span class="line">    <span class="built_in">SI_Start</span>(pSI);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// call si agent</span></span><br><span class="line">    <span class="built_in">SI_Agent_ScanChannel</span>(pSI-&gt;agent, frequency);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//debug...</span></span><br><span class="line">    <span class="built_in">SI_DB_PRINT_ALL_TSNODE</span>(pSI-&gt;db);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">SI_API_RETURN</span>(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>其中，SI_Start方法会把SI_AGENT_STATUS状态更新为SI_AGENT_STATUS_RUNNING，SI_Agent_ScanChannel方法则设置FilterTaskPool：</p>
<ul>
<li><p>SI_Start（pSI）</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/api/SI_Api.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Start</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI									*pSI</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_API_BEGIN();</span><br><span class="line">    SI_ASSERT(pSI);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// start si agent thread</span></span><br><span class="line">    SI_Agent_Start(pSI-&gt;agent);</span><br><span class="line"></span><br><span class="line">    SI_API_RETURN(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/SI_Agent.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Agent_Start</span><span class="params">(SI_AGENT *pAgent)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_AGENT_BEGIN();</span><br><span class="line">    SI_ASSERT(pAgent);</span><br><span class="line"></span><br><span class="line">    SIAG_IF_LOCK(pAgent);</span><br><span class="line"></span><br><span class="line">    pAgent-&gt;status = SI_AGENT_STATUS_RUNNING;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _SI_DEBUG_AGENT_LIFE</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">pthread_t</span>  self;</span><br><span class="line">        self = pthread_self();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"siA call st from %p addr:%p\n"</span>, (<span class="keyword">void</span>*)self, pAgent);</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">//_SI_DEBUG_AGENT_LIFE</span></span></span><br><span class="line"></span><br><span class="line">    SIAG_IF_UNLOCK(pAgent);</span><br><span class="line"></span><br><span class="line">    SI_AGENT_RETURN(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>SI_Agent_ScanChannel(pSI-&gt;agent, frequency)</p>
<p>这里也设置了一遍SI_AGENT_STATUS_RUNNING</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/SI_Agent.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Agent_ScanChannel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_AGENT							*pAgent,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						frequency</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="keyword">if</span>(frequency == SI_API_SCANFILE_FREQUENCY)</span><br><span class="line">    {</span><br><span class="line">        SiAgtIF_ScanProgram((SIAGENT_OBJECT_P)pAgent-&gt;agentObjHandle, ts);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        SiAgtIF_ScanChannel((SIAGENT_OBJECT_P)pAgent-&gt;agentObjHandle, ts);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    pAgent-&gt;status = SI_AGENT_STATUS_RUNNING;</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentInterface.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SiAgtIF_ScanChannel</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, TABLE_TREE_TS_LAYER_P tsNode )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    MAIN_TASK_P pMainTask ;</span><br><span class="line">    pMainTask = SiAgent_SM_GenMainTask_ScanCh(tsNode);</span><br><span class="line">    INSERT_MAIN_TASK_INTO_QUEUE( pSiAgentObj, pMainTask ) ;</span><br><span class="line">    <span class="keyword">return</span> TRUE ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>以上可以看到，通过SiAgent_SM_GenMainTask_ScanCh设置pMainTask，然后将其放入Queue中，SIAGENT_THREAD_SLEEP这个1毫秒不知道是干嘛的：</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define SIAGENT_THREAD_SLEEP_TIME <span class="number">1</span></span><br><span class="line"></span><br><span class="line">#define <span class="constructor">SIAGENT_THREAD_SLEEP(<span class="params">ms</span>)</span> {\</span><br><span class="line">         <span class="keyword">struct</span> timespec delay ;\</span><br><span class="line">         delay.tv_sec = ms<span class="operator"> / </span><span class="number">1000</span> ;\</span><br><span class="line">         delay.tv_nsec = ((ms % <span class="number">1000</span>)*<span class="number">1000000</span>) ;\</span><br><span class="line">         nanosleep(&amp;delay,NULL) ;\</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">#define  <span class="constructor">INSERT_MAIN_TASK_INTO_QUEUE(<span class="params">pAgent</span>, <span class="params">pMainTask</span>)</span> {\</span><br><span class="line">          pthread<span class="constructor">_mutex_lock(&amp;<span class="params">siAgentTaskMutex</span>)</span>;\</span><br><span class="line">          pAgent-&gt;<span class="constructor">InsertMainTaskIntoQueue(<span class="params">pAgent</span>, <span class="params">pMainTask</span>)</span>;\</span><br><span class="line">          pthread<span class="constructor">_mutex_unlock(&amp;<span class="params">siAgentTaskMutex</span>)</span>;\</span><br><span class="line">          <span class="constructor">SIAGENT_THREAD_SLEEP(SIAGENT_THREAD_SLEEP_TIME)</span>;\</span><br><span class="line">         }</span><br></pre></td></tr></tbody></table></figure>

<p>看看是怎么设置pMainTask：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentStateMachine.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">MAIN_TASK_P <span class="title">SiAgent_SM_GenMainTask_ScanCh</span><span class="params">( TABLE_TREE_TS_LAYER_P tsAddr )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    MAIN_TASK_P pMainTask ;</span><br><span class="line"></span><br><span class="line">    pMainTask = (MAIN_TASK_P) SM_MALLOC( <span class="keyword">sizeof</span>(MAIN_TASK_T) ) ;</span><br><span class="line">    <span class="keyword">if</span>(pMainTask!=<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">memset</span>(pMainTask,<span class="number">0</span>,<span class="keyword">sizeof</span>(MAIN_TASK_T) ) ;</span><br><span class="line">        pMainTask-&gt;stateNumber = START_EXEC_TASK ;</span><br><span class="line">        pMainTask-&gt;lastStateNumber = NO_PREVIOUS_STATE ;</span><br><span class="line">        pMainTask-&gt;StateMachineFunction = SiAgent_SM_Main_ScanCh ;</span><br><span class="line">        pMainTask-&gt;pFilterTaskPool = <span class="literal">NULL</span> ;</span><br><span class="line">        pMainTask-&gt;argScanCh.tsAddr = tsAddr ;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pMainTask ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>主要是要设置StateMachineFunction这个，看看它指向的SiAgent_SM_Main_ScanCh，同时请注意，此刻pFilterTaskPool是设置为空的：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentStateMachine.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SiAgent_SM_Main_ScanCh</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, MAIN_TASK_P pMainTask)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> noWaitCount=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> execCount = <span class="number">1</span> ;</span><br><span class="line">    PROGRAMS_INFO_P pProgramsInfo ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> pmtCount,neeToWaitCAT=<span class="number">0</span>,count=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(  ; execCount &gt; <span class="number">0</span> ; execCount -- )</span><br><span class="line">    {</span><br><span class="line">        MAIN_SM_STATE_MSG( pSiAgentObj, pMainTask, <span class="string">"MainTask-ScanCH"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(pMainTask-&gt;stateNumber)</span><br><span class="line">        {</span><br><span class="line">        <span class="keyword">case</span> SM_MAIN_SCANCH_ST_START:</span><br><span class="line">            <span class="comment">//Reset Bean Packer</span></span><br><span class="line">            SiAgtFW_ResetBeanPacker( pSiAgentObj, TRUE);</span><br><span class="line">            pMainTask-&gt;pFilterTaskPool = SiAgent_GenScanChGetPatFtp( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr );</span><br><span class="line">            pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_WAIT_GET_PAT ;</span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        <span class="keyword">case</span> SM_MAIN_SCANCH_ST_END:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool != <span class="literal">NULL</span> )</span><br><span class="line">            {</span><br><span class="line">                SiAgent_StopAllFilterTasks( pSiAgentObj, pMainTask-&gt;pFilterTaskPool );</span><br><span class="line">                SM_FREE( pMainTask-&gt;pFilterTaskPool );</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        <span class="keyword">case</span> SM_MAIN_SCANCH_ST_WAIT_GET_PAT:</span><br><span class="line">            NULL_CHECK(pMainTask-&gt;pFilterTaskPool,pMainTask-&gt;stateNumber);</span><br><span class="line">            NULL_CHECK(pMainTask-&gt;pFilterTaskPool-&gt;filterTask,pMainTask-&gt;stateNumber);</span><br><span class="line">            <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber == pMainTask-&gt;pFilterTaskPool-&gt;doneFilterTaskNumber ||</span><br><span class="line">                    pMainTask-&gt;pFilterTaskPool-&gt;filterTask[<span class="number">0</span>].filterTaskState == FILTER_TASK_STATE_DONE)</span><br><span class="line">            {</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[<span class="number">0</span>].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_TIMEOUT )&amp;&amp;</span><br><span class="line">                    (!SI_IS_SCAN_CH_SKIP_PAT_INVALID(pSiAgentObj-&gt;si)))</span><br><span class="line">                {   <span class="comment">//No PAT</span></span><br><span class="line">                    SM_FREE( pMainTask-&gt;pFilterTaskPool );</span><br><span class="line">                    pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_END ;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG_SIAGENT_SM_</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"No PAT\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//_DEBUG_SIAGENT_SM_</span></span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Msg to AP : No VC in TS (No PAT) !!!!!!!!!!!!!</span></span><br><span class="line">                    <span class="keyword">if</span>(pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL] != <span class="literal">NULL</span>)</span><br><span class="line">                    {</span><br><span class="line">                        pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si,  <span class="literal">NULL</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {</span><br><span class="line">                    BOOL bOpenPMT=TRUE;</span><br><span class="line">                    <span class="comment">//Got PAT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">                    <span class="keyword">if</span>(pSiAgentObj-&gt;si-&gt;eScanBase == SI_SCAN_SDT_BASE &amp;&amp; pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber&gt;<span class="number">1</span>)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="keyword">if</span>(pMainTask-&gt;pFilterTaskPool-&gt;filterTask[<span class="number">1</span>].filterTaskState != FILTER_TASK_STATE_DONE)</span><br><span class="line">                        {</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG_SIAGENT_SM_</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Got PAT\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//_DEBUG_SIAGENT_SM_</span></span></span><br><span class="line">                    <span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber; i++) {</span><br><span class="line">                        <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_TIMEOUT) {</span><br><span class="line">                            <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].chkTableReceiveFunction == CHK_TABLE_RECEIVE_FUNC_A_NIT) {</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"No NIT.\n"</span>);</span><br><span class="line">                            } <span class="keyword">else</span> <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].chkTableReceiveFunction == CHK_TABLE_RECEIVE_FUNC_A_SDT) {</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"No SDT.\n"</span>);</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].chkTableReceiveFunction == CHK_TABLE_RECEIVE_FUNC_A_NIT) {</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"Got NIT.\n"</span>);</span><br><span class="line">                            } <span class="keyword">else</span> <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].chkTableReceiveFunction == CHK_TABLE_RECEIVE_FUNC_A_SDT) {</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">"Got SDT.\n"</span>);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(<span class="comment">/*SI_IS_UNITYMEDIA(*/</span>pSiAgentObj-&gt;si-&gt;bSkipPMT<span class="comment">/*)*/</span>&amp;&amp;(SI_HAS_STATE(pSiAgentObj-&gt;si-&gt;state, SI_STATE_AUTOSCAN)</span><br><span class="line">                                            ||SI_HAS_STATE(pSiAgentObj-&gt;si-&gt;state, SI_STATE_NETWORKSCAN)))</span><br><span class="line">                    {</span><br><span class="line">                        bOpenPMT=FALSE;</span><br><span class="line">                    }</span><br><span class="line">                    SM_FREE( pMainTask-&gt;pFilterTaskPool );</span><br><span class="line">                    pProgramsInfo = SiAgtFW_GetProgramsInfo( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr );</span><br><span class="line">                    pMainTask-&gt;pFilterTaskPool = SiAgent_GenScanChGetTablesFtp( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr, pProgramsInfo , <span class="comment">/*pSiAgentObj-&gt;si-&gt;eScanBase == SI_SCAN_SDT_BASE ? FALSE :*/</span> TRUE,bOpenPMT);</span><br><span class="line">                    SiAgtFW_FreeProgramsInfo(pSiAgentObj, &amp;pProgramsInfo );</span><br><span class="line">                    pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_WAIT_GET_TABLES ;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        <span class="keyword">case</span> SM_MAIN_SCANCH_ST_WAIT_GET_TABLES:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ENABLE_NEW_DVB<span class="comment">//why need CAT in NO CA project</span></span></span><br><span class="line">            neeToWaitCAT=<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            count=<span class="number">0</span>;</span><br><span class="line">            noWaitCount=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( SI_HAS_STATE(pSiAgentObj-&gt;si-&gt;state, SI_STATE_AUTOSCAN)  &amp;&amp; (<span class="comment">/*SI_IS_SATELLITE(pSiAgentObj-&gt;si)||*/</span>SI_IS_CABLE(pSiAgentObj-&gt;si)) &amp;&amp; SiAgtFW_CheckPatExist( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr ) == TRUE</span><br><span class="line">                    &amp;&amp; SiAgtFW_CheckActualSdtReceive( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr ,TRUE)==TRUE</span><br><span class="line">                    &amp;&amp; SiAgtFW_CheckActualNitReceive( pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr,<span class="literal">NULL</span>) == FALSE</span><br><span class="line">                    &amp;&amp; SiAgtFW_DuplicateNit(pSiAgentObj,pMainTask-&gt;argScanCh.tsAddr )==TRUE)</span><br><span class="line">            {</span><br><span class="line">                noWaitCount++;</span><br><span class="line">            }</span><br><span class="line">            NULL_CHECK(pMainTask-&gt;pFilterTaskPool,pMainTask-&gt;stateNumber);</span><br><span class="line">            NULL_CHECK(pMainTask-&gt;pFilterTaskPool-&gt;filterTask,pMainTask-&gt;stateNumber);</span><br><span class="line">            <span class="keyword">if</span> ((pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber<span class="number">-1</span>)==pMainTask-&gt;pFilterTaskPool-&gt;doneFilterTaskNumber) {</span><br><span class="line">                <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber; i++) {</span><br><span class="line">                    <span class="keyword">if</span>(i==SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_CAT)<span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.closedReason==FILTER_TASK_CLOSED_REASON_RECEIVED) {</span><br><span class="line">                        count++;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ENABLE_NIKE_CUNCUNTONG</span></span><br><span class="line">                <span class="keyword">if</span>(SI_IS_KABEL_DEUTSCHLAND(pSiAgentObj-&gt;si))</span><br><span class="line">                {</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (SI_ENABLE_BAT_6100(pSiAgentObj-&gt;si)==FALSE &amp;&amp;</span><br><span class="line">                         pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_BAT_6100].typeTimeoutClosed.closedReason==FILTER_TASK_CLOSED_REASON_TIMEOUT) {</span><br><span class="line">                    count++;</span><br><span class="line">                }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ENABLE_NEW_DVB<span class="comment">//why need CAT in NO CA project</span></span></span><br><span class="line">                <span class="keyword">if</span> ((count+<span class="number">1</span>)==pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber) {</span><br><span class="line">                    neeToWaitCAT=SiAgtFW_NeedToQueryCAT(pSiAgentObj, pMainTask-&gt;argScanCh.tsAddr);</span><br><span class="line">                }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>( ((pMainTask-&gt;pFilterTaskPool-&gt;doneFilterTaskNumber+noWaitCount) &gt;= pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber ) ||</span><br><span class="line">                    ((pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber<span class="number">-1</span>)==pMainTask-&gt;pFilterTaskPool-&gt;doneFilterTaskNumber &amp;&amp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_NEW_DVB<span class="comment">//why need CAT in NO CA project</span></span></span><br><span class="line">                     pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_CAT].filterTaskState==FILTER_TASK_STATE_DOING</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                     neeToWaitCAT==<span class="number">0</span> &amp;&amp;</span><br><span class="line">                     pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_CAT].typeTimeoutClosed.closedReason!=FILTER_TASK_CLOSED_REASON_RECEIVED</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    ) )</span><br><span class="line">            {</span><br><span class="line">                pmtCount = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//if( pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber &gt; SI_AGENT_FILTER_GET_SCAN_CH_TABLE_PREFIX )//for empty PAT</span></span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">for</span>( i =<span class="number">0</span>; i &lt; pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber ; i ++ )</span><br><span class="line">                    {</span><br><span class="line">                        <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].chkTableReceiveFunction == CHK_TABLE_RECEIVE_FUNC_PMT</span><br><span class="line">                                &amp;&amp; pMainTask-&gt;pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED )</span><br><span class="line">                        {</span><br><span class="line">                            pmtCount ++ ;</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>( pmtCount &gt; <span class="number">0</span> || pSiAgentObj-&gt;si-&gt;eScanBase == SI_SCAN_SDT_BASE || pSiAgentObj-&gt;si-&gt;eScanBase == SI_SCAN_NIT_BASE)</span><br><span class="line">                {   <span class="comment">//Got PMT</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"Got PMT[%d],fail:%d.\n"</span>,pmtCount,(pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber-SI_AGENT_FILTER_GET_SCAN_CH_TABLE_PREFIX-pmtCount));</span><br><span class="line">                    <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_NIT].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED ) {</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Got NIT.\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> GET_SCAN_PARAM_FROM_NIT</span></span><br><span class="line">                        pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_GET_NIT](pSiAgentObj-&gt;si, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_SDT].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED ) {</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Got SDT.\n"</span>);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_CAT].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED ) {</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Got CAT.\n"</span>);</span><br><span class="line">                    }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_NIKE_CUNCUNTONG</span></span><br><span class="line">                    <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_BAT_6000].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED)</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"Got BAT_0x6000.\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">                    <span class="keyword">if</span> (SI_ENABLE_BAT_6100(pSiAgentObj-&gt;si)) {</span><br><span class="line">                        <span class="keyword">if</span>( pMainTask-&gt;pFilterTaskPool-&gt;filterTask[SI_AGENT_FILTER_GET_SCAN_CH_TABLE_INDEX_BAT_6100].typeTimeoutClosed.closedReason == FILTER_TASK_CLOSED_REASON_RECEIVED ) {</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Got BAT[0x6100].\n"</span>);</span><br><span class="line">                        } <span class="keyword">else</span> {</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">"Fail BAT[0x6100].\n"</span>);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    SM_FREE( pMainTask-&gt;pFilterTaskPool );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">                    <span class="keyword">if</span>(SI_IS_HD_PLUS<span class="comment">/*SI_IS_SATELLITE*/</span>(pSiAgentObj-&gt;si) &amp;&amp; !SiAgtFW_IsSgtExist(pSiAgentObj))</span><br><span class="line">                    {</span><br><span class="line">                        pMainTask-&gt;pFilterTaskPool=SiAgent_GenScanSgtFtp(pSiAgentObj,pMainTask-&gt;argScanCh.tsAddr);</span><br><span class="line">                        <span class="keyword">if</span>(pMainTask-&gt;pFilterTaskPool!=<span class="literal">NULL</span>)</span><br><span class="line">                        {</span><br><span class="line">                            pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_WAIT_SGT_TABLES;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                    pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_END ;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Msg to AP : Some VCs in TS !!!!!!!!!!!!!</span></span><br><span class="line">                    <span class="keyword">if</span>(pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL] != <span class="literal">NULL</span>)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="comment">//pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si, (void*)1);</span></span><br><span class="line">                        pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si, pMainTask-&gt;argScanCh.tsAddr);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {   <span class="comment">//No PMT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG_SIAGENT_SM_</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"No PMT\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">//_DEBUG_SIAGENT_SM_</span></span></span><br><span class="line"></span><br><span class="line">                    SM_FREE( pMainTask-&gt;pFilterTaskPool );</span><br><span class="line">                    pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_END ;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Msg to AP : No VC in TS (No PMT) !!!!!!!!!!!!!</span></span><br><span class="line">                    <span class="keyword">if</span>(pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL] != <span class="literal">NULL</span>)</span><br><span class="line">                    {</span><br><span class="line">                        pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si, <span class="literal">NULL</span>);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        <span class="keyword">case</span> SM_MAIN_SCANCH_ST_WAIT_SGT_TABLES:</span><br><span class="line">            NULL_CHECK(pMainTask-&gt;pFilterTaskPool,pMainTask-&gt;stateNumber);</span><br><span class="line">            <span class="keyword">if</span> (pMainTask-&gt;pFilterTaskPool-&gt;totalFilterTaskNumber==pMainTask-&gt;pFilterTaskPool-&gt;doneFilterTaskNumber)</span><br><span class="line">            {</span><br><span class="line">                pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_END ;</span><br><span class="line">                <span class="keyword">if</span>(pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL] != <span class="literal">NULL</span>)</span><br><span class="line">                {</span><br><span class="line">                    pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si, pMainTask-&gt;argScanCh.tsAddr);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            SM_DBG_MSG(DBG_MSG_LEVEL_ERROR, <span class="string">"[SiAgent-%s]:'Main Task - Scan Channel' has unknown state(%d)."</span>,pSiAgentObj-&gt;agentObjectName, pMainTask-&gt;stateNumber);</span><br><span class="line">            pMainTask-&gt;stateNumber = SM_MAIN_SCANCH_ST_END ;</span><br><span class="line">            execCount ++ ;</span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    MAIN_TASK_ENDING_MSG( pSiAgentObj, pMainTask, <span class="string">"MainTask-ScanCH"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，当拿到<code>PMT</code>时，调用</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_SCAN_CHANNEL](pSiAgentObj-&gt;si, pMainTask-&gt;argScanCh.tsAddr);</span><br></pre></td></tr></tbody></table></figure>

<p>也就是前面注册的回调函数SI_Callback_ScanChannel。</p>
</li>
</ul>
<p>至此，ScanStart()跑完，然后RunStateProc状态机状态被更新为FREQ_SCAN_STATE_CHECK_SI。</p>
<h4 id="RunStateProc-FREQ-SCAN-STATE-CHECK-SI"><a href="#RunStateProc-FREQ-SCAN-STATE-CHECK-SI" class="headerlink" title="RunStateProc FREQ_SCAN_STATE_CHECK_SI"></a>RunStateProc FREQ_SCAN_STATE_CHECK_SI</h4><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Channel/Scan/DtvFreqDetector.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CDtvFreqDetector::xStageCheckSi</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	DTV_STACK::TunerMgr* tuner = DTV_STACK::TunerMgr::<span class="built_in">getInstance</span>();</span><br><span class="line"></span><br><span class="line">RETRY:</span><br><span class="line">	<span class="keyword">if</span> (m_pIDtvMedia-&gt;<span class="built_in">GetSiMgr</span>()-&gt;<span class="built_in">ScanIsDone</span>(&amp;m_bIsGetService) == <span class="literal">false</span>)</span><br><span class="line">	{</span><br><span class="line">		m_pIDtvMedia-&gt;<span class="built_in">GetSiMgr</span>()-&gt;<span class="built_in">SetSignalInfo</span>(tuner-&gt;<span class="built_in">getRFStrength</span>(), tuner-&gt;<span class="built_in">getSignalSNR</span>());</span><br><span class="line">		<span class="built_in">usleep</span>(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_SUPPORT_DVB_S</span></span><br><span class="line">		<span class="keyword">if</span>(m_curLoHz != <span class="number">0</span>)</span><br><span class="line">		{</span><br><span class="line">			<span class="keyword">if</span>(!m_bCancelScan)</span><br><span class="line">				<span class="keyword">goto</span> RETRY;</span><br><span class="line">		}</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Terrestrial case :</span></span><br><span class="line">	<span class="comment">// We should check if we need to check current frequency again with different parameters</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">HasHandleCurFreqAgainInDvbT</span>())</span><br><span class="line">	{</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Fill modulation to each channel to prevent error when playing channel</span></span><br><span class="line">	m_pIDtvMedia-&gt;<span class="built_in">GetSiMgr</span>()-&gt;<span class="built_in">SetModulation</span>(m_curFreq, m_modulation);</span><br><span class="line">	m_scanState = FREQ_SCAN_STATE_END_FREQ;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_SUPPORT_DVB_S</span></span><br><span class="line">	<span class="keyword">if</span>(m_curLoHz != <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">UpdateChInfo</span>();</span><br><span class="line">		<span class="built_in">SendEvent</span>(RT_SCAN_EVENT_FREQ_DONE, m_curFreq);</span><br><span class="line">		m_scanState = FREQ_SCAN_STATE_BLIND_SCAN_TP;</span><br><span class="line">	}</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>关注这个ScanIsDone：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* MediaControl/Component/Si/DvbSiMgr.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">CDvbSiMgr::ScanIsDone</span><span class="params">(<span class="keyword">bool</span> *bGetCh)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_MESSAGE message;</span><br><span class="line">    UINT32 data = <span class="number">0</span>;</span><br><span class="line">    DriverBasedDtvApp *pDvbApp = m_pTvMedia-&gt;<span class="built_in">GetDtvFlow</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pDvbApp-&gt;<span class="built_in">GetSiMessage</span>(&amp;message, &amp;data) == <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (message == SI_MESSAGE_RESET_CHANNEL &amp;&amp; data&gt;<span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">xResetChannel</span>(data);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(message == SI_MESSAGE_CHANNEL_UPDATE &amp;&amp; data&gt;<span class="number">0</span>) {</span><br><span class="line">        <span class="built_in">xUpdateChannelMgr</span>(data);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (message == SI_MESSAGE_CH_INFO_READY)</span><br><span class="line">    {</span><br><span class="line">    	<span class="built_in">ALOGD</span>(<span class="string">"[%s %d] SI_MESSAGE_CH_INFO_READY\n"</span>,__func__,__LINE__);</span><br><span class="line">        <span class="keyword">if</span>(bGetCh!=<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            *bGetCh = data == <span class="number">0</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (message == SI_MESSAGE_SSU_SW_NOT_FOUND||message == SI_MESSAGE_SSU_SWINFO_READY)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(bGetCh!=<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            *bGetCh = message == SI_MESSAGE_SSU_SWINFO_READY ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span><span class="comment">/* if (message != SI_MESSAGE_CH_INFO_READY)*/</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>收到这个SI_MESSAGE_CH_INFO_READY消息，就认为Check SI完成，这个消息就是回调函数SI_Callback_ScanChannel发出来的。然后接着跑RunStateProc的剩余流程。</p>
<h3 id="SI-AGENT-STATUS-RUNNING"><a href="#SI-AGENT-STATUS-RUNNING" class="headerlink" title="SI_AGENT_STATUS_RUNNING"></a>SI_AGENT_STATUS_RUNNING</h3><p>上面讲到，SiAgent_SM_Main_ScanCh的时候，如果拿到<code>PMT</code>，就认为扫到台，接着会跑SI_Callback_ScanChannel这个回调函数，但是SiAgent_SM_Main_ScanCh什么时候才会被调用呢？SiAgent_SM_GenMainTask_ScanCh只是设置了pMainTask-&gt;StateMachineFunction，但是还没有执行，什么时候执行？</p>
<h4 id="RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND-1"><a href="#RunStateProc-FREQ-SCAN-STATE-CHECK-FRONTEND-1" class="headerlink" title="RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND"></a>RunStateProc FREQ_SCAN_STATE_CHECK_FRONTEND</h4><p>别忘了，si_agent_threadfuntion这个线程里，SI_Agent_CollectSection函数还卡着呢，什么时候才跑进所需的流程？要看SI_AGENT_STATUS这个状态，根据前面的分析，在Check Frontend阶段，状态被更新为SI_AGENT_STATUS_RUNNING。</p>
<p>好戏开场了：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(agent-&gt;status == SI_AGENT_STATUS_RUNNING)</span><br><span class="line">{</span><br><span class="line">    SiAgtIF_Run(agent-&gt;agentObjHandle);</span><br><span class="line">    SI_Collector_CollectSection(agent-&gt;collector, agent-&gt;db, agent-&gt;tp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>先讲SiAgtIF_Run：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentInterface.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SiAgtIF_Run</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    pSiAgentObj-&gt;Run( pSiAgentObj );</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentObject.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SiAgentObj_Run</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    pSiAgentObj-&gt;ExecMainTaskSM( pSiAgentObj );</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;SUB_TASK_QUEUE_NUMBER; i++) {</span><br><span class="line">        pSiAgentObj-&gt;ExecSubTaskSM( pSiAgentObj, i);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_MONITOR_TICK] != <span class="literal">NULL</span>) {</span><br><span class="line">        pSiAgentObj-&gt;siAgentCBFs[SI_AGENT_CBF_TYPE_MONITOR_TICK](pSiAgentObj-&gt;si,<span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里的ExecMainTaskSM就是SiAgentObj_ExecMainTaskSM，由最开始CH_SCAN_STATE_INIT阶段初始化的，现在终于派上用场：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentObject.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SiAgentObj_ExecMainTaskSM</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    BOOL result ;</span><br><span class="line">    MAIN_TASK_INFO_P pExecMainTaskInfo = &amp;(pSiAgentObj-&gt;execMainTaskInfo) ;</span><br><span class="line"></span><br><span class="line">    CHECK_MAIN_TASK_IN_QUEUE( pSiAgentObj, &amp;result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( result == TRUE )</span><br><span class="line">    {   <span class="comment">//New Task in Queue</span></span><br><span class="line">        <span class="keyword">if</span>( pExecMainTaskInfo-&gt;pExecMainTask != <span class="literal">NULL</span> )</span><br><span class="line">        {   <span class="comment">//Finish Current Task</span></span><br><span class="line">            pExecMainTaskInfo-&gt;pExecMainTask-&gt;stateNumber = STOP_EXEC_TASK ;</span><br><span class="line">            pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask )  ;</span><br><span class="line">            AGENTOBJ_FREE(pExecMainTaskInfo-&gt;pExecMainTask);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//Load New Task into State Machine</span></span><br><span class="line">        GET_MAIN_TASK_FROM_QUEUE( pSiAgentObj, &amp;(pExecMainTaskInfo-&gt;pExecMainTask));</span><br><span class="line"></span><br><span class="line">        pExecMainTaskInfo-&gt;pExecMainTask-&gt;lastTaskIsChgCh = pExecMainTaskInfo-&gt;lastTaskIsChgCh ;</span><br><span class="line">        pExecMainTaskInfo-&gt;pExecMainTask-&gt;lastTsAddr      = pExecMainTaskInfo-&gt;lastTsAddr ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction == SiAgent_SM_Main_ChangeCh) ||</span><br><span class="line">                (pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction == SiAgent_SM_Main_RecordPrg) )</span><br><span class="line">        {</span><br><span class="line">            pExecMainTaskInfo-&gt;lastTaskIsChgCh = TRUE ;</span><br><span class="line">            pExecMainTaskInfo-&gt;lastTsAddr  =  pExecMainTaskInfo-&gt;pExecMainTask-&gt;argChangeCh.tsAddr ;<span class="comment">//argChangeCh==argRecordPrg</span></span><br><span class="line">        }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction == SiAgent_SM_Main_ChgChSsuDecode)</span><br><span class="line">        {</span><br><span class="line">            pExecMainTaskInfo-&gt;lastTaskIsChgCh = TRUE ;</span><br><span class="line">            pExecMainTaskInfo-&gt;lastTsAddr  =  pExecMainTaskInfo-&gt;pExecMainTask-&gt;argChgChSsuDcr.tsAddr ;<span class="comment">//argChangeCh==argRecordPrg</span></span><br><span class="line">        }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">//ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction!=SiAgent_SM_Main_Stop)</span><br><span class="line">        {</span><br><span class="line">            pExecMainTaskInfo-&gt;lastTaskIsChgCh = FALSE ;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pExecMainTaskInfo-&gt;pExecMainTask != <span class="literal">NULL</span> )</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>( pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool != <span class="literal">NULL</span> )</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//Update Filter Task State</span></span><br><span class="line">            SiAgent_UpdateFilterTaskState( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool );</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//EXEC TASK</span></span><br><span class="line">        pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask )   ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool != <span class="literal">NULL</span> )</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">//EXEC Filter Task</span></span><br><span class="line">            SiAgent_ExecuteFilterTask( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool );</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( pExecMainTaskInfo-&gt;pExecMainTask-&gt;stateNumber == STOP_EXEC_TASK )</span><br><span class="line">        {</span><br><span class="line">            AGENTOBJ_FREE(pExecMainTaskInfo-&gt;pExecMainTask);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>前面流程，SI_AGENT_STATUS_RUNNING在Check Frontend阶段被设置了，这个时候，si_agent_threadfuntion线程可以进以下流程：</p>
<blockquote>
<p>si_agent_threadfuntion()</p>
<blockquote>
<p>SI_Agent_CollectSection(agent)</p>
<blockquote>
<p>SiAgtIF_Run(agent-&gt;agentObjHandle)</p>
<p>SiAgentObj_Run(SIAGENT_OBJECT_P pSiAgentObj)</p>
<blockquote>
<p>pSiAgentObj-&gt;ExecMainTaskSM(pSiAgentObj)</p>
<p>SiAgentObj_ExecMainTaskSM( SIAGENT_OBJECT_P pSiAgentObj )</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>前面把MainTask放入队列的时候，线程延迟1毫秒，让出CPU使用权，现在SiAgentObj_ExecMainTaskSM CHECK_MAIN_TASK_IN_QUEUE( pSiAgentObj, &amp;result)，也是同样的做法：</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#define  <span class="constructor">CHECK_MAIN_TASK_IN_QUEUE(<span class="params">pAgent</span>, <span class="params">pResult</span>)</span> {\</span><br><span class="line">          pthread<span class="constructor">_mutex_lock(&amp;<span class="params">siAgentTaskMutex</span>)</span>;\</span><br><span class="line">          pAgent-&gt;<span class="constructor">CheckMainTaskInQueue(<span class="params">pAgent</span>, <span class="params">pResult</span>)</span>;\</span><br><span class="line">          pthread<span class="constructor">_mutex_unlock(&amp;<span class="params">siAgentTaskMutex</span>)</span>;\</span><br><span class="line">          <span class="constructor">SIAGENT_THREAD_SLEEP(SIAGENT_THREAD_SLEEP_TIME)</span>;\</span><br><span class="line">         }</span><br></pre></td></tr></tbody></table></figure>

<p>所以，这个有什么用？不知道。反正SiAgentObj_ExecMainTaskSM里面的执行时机搞不懂。<span class="github-emoji"><span>😂</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<p>然后再讲SI_Collector_CollectSection：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/collector/SI_Collector.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Collector_CollectSection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_COLLECTOR *pCollector,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_DATABASE	*pDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span>		*tp</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;pCollector-&gt;beanQueueNum; i++)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">//省略代码段</span></span><br><span class="line">        <span class="comment">// get bean queue and beanQLen from tp or something</span></span><br><span class="line">        SI_TPInterface_GetBeanQueue(tp, i, &amp;beanQueueLen, &amp;beanQueue);</span><br><span class="line">        <span class="keyword">if</span>(!beanQueueLen)</span><br><span class="line">        {   <span class="comment">//beanQueueLen = 0</span></span><br><span class="line">            <span class="keyword">if</span>(beanQueue)</span><br><span class="line">            {</span><br><span class="line">                SI_TPInterface_DropBeanQueue(tp, beanQueue);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        beanQueueToParseLen = beanQueueLen + pCollector-&gt;beanCtrlInfo[i].surplusLength;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//kjw: todo</span></span><br><span class="line">        <span class="comment">//if beanQueueToParseLen == beanQueueLen, we don't need to dup beanQueueToParse again...</span></span><br><span class="line"></span><br><span class="line">        beanQueueToParse = SI_COLLECTOR_MALLOC(beanQueueToParseLen);</span><br><span class="line">        <span class="keyword">if</span> (beanQueueToParse==<span class="literal">NULL</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(pCollector-&gt;beanCtrlInfo[i].allocatedAddr)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">memcpy</span>(beanQueueToParse, pCollector-&gt;beanCtrlInfo[i].surplusAddr, pCollector-&gt;beanCtrlInfo[i].surplusLength);</span><br><span class="line">            SI_COLLECTOR_FREE(pCollector-&gt;beanCtrlInfo[i].allocatedAddr);</span><br><span class="line">            pCollector-&gt;beanCtrlInfo[i].allocatedAddr = <span class="literal">NULL</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">memcpy</span>(beanQueueToParse+pCollector-&gt;beanCtrlInfo[i].surplusLength, beanQueue, beanQueueLen);</span><br><span class="line"></span><br><span class="line">        SI_TPInterface_DropBeanQueue(tp, beanQueue);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        surplusLen = beanQueueToParseLen;</span><br><span class="line">        pthread_mutex_lock(&amp;pCollector-&gt;mutexSectionFilter);<span class="comment">//#ifdef ENABLE_MHEG5, fix not thread safe</span></span><br><span class="line">        si_collector_insert_to_database(pCollector, pDatabase, &amp;surplusLen, beanQueueToParse);</span><br><span class="line">        pthread_mutex_unlock(&amp;pCollector-&gt;mutexSectionFilter);<span class="comment">//#ifdef ENABLE_MHEG5, fix not thread safe</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//省略代码段</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    SI_COLLECTOR_RETURN(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里应该是从SI_TPInterface_GetBeanQueue拿ts packet，加打印信息，continue关键字会一直拦截后面的语句，所以这里的作用单纯是拿ts packet？</p>
<h4 id="RunStateProc-FREQ-SCAN-STATE-CHECK-SI-1"><a href="#RunStateProc-FREQ-SCAN-STATE-CHECK-SI-1" class="headerlink" title="RunStateProc FREQ_SCAN_STATE_CHECK_SI"></a>RunStateProc FREQ_SCAN_STATE_CHECK_SI</h4><p>再绕回来讲SiAgentObj_ExecMainTaskSM执行时机，其实没得讲，因为不知道。总之，Check SI的时候，SiAgentObj_ExecMainTaskSM会跑进以下3个流程：</p>
<blockquote>
<p>SiAgent_UpdateFilterTaskState( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool );</p>
<p>pExecMainTaskInfo-&gt;pExecMainTask-&gt;StateMachineFunction( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask )   ;</p>
<p>SiAgent_ExecuteFilterTask( pSiAgentObj, pExecMainTaskInfo-&gt;pExecMainTask-&gt;pFilterTaskPool );</p>
</blockquote>
<p>SiAgent_UpdateFilterTaskState这个是更新Filter状态的，比如说Receive到某个Table之后就把closedReason更新为FILTER_TASK_CLOSED_REASON_RECEIVED，并关掉对应的Filter；</p>
<p>StateMachineFunction这个，也就是对应扫台的SiAgent_SM_Main_ScanCh，用来设置Filter的，也通过Filter的closedReason判断是否拿到<code>PMT，</code>如果是FILTER_TASK_CLOSED_REASON_RECEIVED，则拿到；</p>
<p>SiAgent_ExecuteFilterTask是用来实际执行Filter的：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentFilterTaskExecutor.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SiAgent_ExecuteFilterTask</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, FILTER_TASK_POOL_P pFilterTaskPool )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> totalFilterTaskNumber ;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> i ;</span><br><span class="line">    <span class="keyword">time_t</span> targetCurrentTime ;</span><br><span class="line">    BOOL bCreate;</span><br><span class="line"></span><br><span class="line">    FTE_DBG_MSG(DBG_MSG_LEVEL_INFO, <span class="string">"[SiAgent-%s]:Execute Filter Task."</span>,pSiAgentObj-&gt;agentObjectName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pFilterTaskPool-&gt;doingFilterTaskNumber &lt; pFilterTaskPool-&gt;maxSecFilterNumber )</span><br><span class="line">    {</span><br><span class="line">        targetCurrentTime = SiAgent_GetTime(pSiAgentObj);</span><br><span class="line"></span><br><span class="line">        pFilterTaskPool-&gt;targetCurrentTime = targetCurrentTime ;</span><br><span class="line"></span><br><span class="line">        totalFilterTaskNumber = pFilterTaskPool-&gt;totalFilterTaskNumber ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>( i = <span class="number">0</span> ; i &lt; totalFilterTaskNumber ; i ++ )</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span>( pFilterTaskPool-&gt;filterTask[i].filterTaskState == FILTER_TASK_STATE_TO_DO )</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span>( pFilterTaskPool-&gt;doingFilterTaskNumber &lt; pFilterTaskPool-&gt;maxSecFilterNumber )</span><br><span class="line">                {</span><br><span class="line">                    bCreate=TRUE;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">switch</span>( pFilterTaskPool-&gt;filterTask[i].filterTaskType )</span><br><span class="line">                    {</span><br><span class="line">                    <span class="keyword">case</span> FILTER_TASK_TYPE_TIMEOUT_AUTO_CLOSED:</span><br><span class="line">                        <span class="keyword">if</span>(pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.endingTime&gt;<span class="number">0</span>)</span><br><span class="line">                        {</span><br><span class="line">                            bCreate=SiAgent_FTE_EnableSecFilter( pSiAgentObj, &amp;(pFilterTaskPool-&gt;filterTask[i]) );</span><br><span class="line">                            <span class="keyword">if</span>(bCreate)</span><br><span class="line">                            {</span><br><span class="line">                                pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.timeout=pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.endingTime;</span><br><span class="line">                                pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.endingTime += (targetCurrentTime+<span class="number">1</span>) ;<span class="comment">//fix incorrect timeout ,0.99999~1</span></span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        {</span><br><span class="line">                            pFilterTaskPool-&gt;filterTask[i].filterTaskState = FILTER_TASK_STATE_DOING;</span><br><span class="line">                            pFilterTaskPool-&gt;todoFilterTaskNumber -- ;</span><br><span class="line">                            bCreate=FALSE;</span><br><span class="line">                            pFilterTaskPool-&gt;doneFilterTaskNumber  ++ ;</span><br><span class="line">                            pFilterTaskPool-&gt;filterTask[i].typeTimeoutClosed.closedReason = FILTER_TASK_CLOSED_REASON_TIMEOUT ;</span><br><span class="line">                            pFilterTaskPool-&gt;filterTask[i].filterTaskState = FILTER_TASK_STATE_DONE ;</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">break</span> ;</span><br><span class="line">                    <span class="keyword">case</span> FILTER_TASK_TYPE_RECEIVE_AUTO_CLOSED:</span><br><span class="line">                    <span class="keyword">case</span> FILTER_TASK_TYPE_OPEN_CONTINUOUSLY  :</span><br><span class="line">                        bCreate=SiAgent_FTE_EnableSecFilter( pSiAgentObj, &amp;(pFilterTaskPool-&gt;filterTask[i]) );</span><br><span class="line">                        <span class="keyword">break</span> ;</span><br><span class="line">                    <span class="keyword">default</span> :</span><br><span class="line">                        <span class="keyword">break</span> ;</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span>(bCreate)</span><br><span class="line">                    {</span><br><span class="line">                        pFilterTaskPool-&gt;filterTask[i].filterTaskState = FILTER_TASK_STATE_DOING;</span><br><span class="line">                        pFilterTaskPool-&gt;todoFilterTaskNumber -- ;</span><br><span class="line">                        pFilterTaskPool-&gt;doingFilterTaskNumber ++ ;</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentFilterTaskExecutor.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SiAgent_FTE_EnableSecFilter</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, FILTER_TASK_P pFilterTask )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    FTE_DBG_MSG(DBG_MSG_LEVEL_INFO, <span class="string">"[SiAgent-%s]:Enable Virtual Section Filter."</span>,pSiAgentObj-&gt;agentObjectName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>( pFilterTask-&gt;secFilterFunction )</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_GET_TABLE      :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_GetTableFilter( pSiAgentObj, pFilterTask-&gt;argGetTable.pid, pFilterTask-&gt;argGetTable.tid ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_MONITOR_PAT    :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_MonitorPatFilter( pSiAgentObj, pFilterTask-&gt;argMonitorPat.pid, pFilterTask-&gt;argMonitorPat.tid, pFilterTask-&gt;argMonitorPat.tsid, pFilterTask-&gt;argMonitorPat.version ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_GET_PMT        :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_GetPmtFilter( pSiAgentObj, pFilterTask-&gt;argGetPmt.pid, pFilterTask-&gt;argGetPmt.tid, pFilterTask-&gt;argGetPmt.programNumber ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_MONITOR_PMT    :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_MonitorPmtFilter( pSiAgentObj, pFilterTask-&gt;argMonitorPmt.pid, pFilterTask-&gt;argMonitorPmt.tid, pFilterTask-&gt;argMonitorPmt.programNumber, pFilterTask-&gt;argMonitorPmt.version ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_MONITOR_TABLE  :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_MonitorTableFilter( pSiAgentObj, pFilterTask-&gt;argMonitorTable.pid, pFilterTask-&gt;argMonitorTable.tid, pFilterTask-&gt;argMonitorTable.version ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_GET_APF_EIT    :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_GetApfEitFilter( pSiAgentObj, pFilterTask-&gt;argGetApfEit.pid, pFilterTask-&gt;argGetApfEit.tid, pFilterTask-&gt;argGetApfEit.serviceId, pFilterTask-&gt;argGetApfEit.sectionNumber ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_MONITOR_APF_EIT:</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_MonitorApfEitFilter( pSiAgentObj, pFilterTask-&gt;argMonitorApfEit.pid, pFilterTask-&gt;argMonitorApfEit.tid, pFilterTask-&gt;argMonitorApfEit.serviceId, pFilterTask-&gt;argMonitorApfEit.sectionNumber, pFilterTask-&gt;argMonitorApfEit.version ) ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_GET_DXI        :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_GetDxiFilter(pSiAgentObj, pFilterTask-&gt;argGetDxi.pid, pFilterTask-&gt;argGetDxi.tid, pFilterTask-&gt;argGetDxi.id );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_MONITOR_DXI    :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_MonitorDxiFilter(pSiAgentObj, pFilterTask-&gt;argMonitorDxi.pid, pFilterTask-&gt;argMonitorDxi.tid, pFilterTask-&gt;argMonitorDxi.id, pFilterTask-&gt;argMonitorDxi.versionFlag );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SEC_FLTR_FUNC_GET_SSU_DDB    :</span><br><span class="line">        <span class="keyword">return</span> SiAgent_Enable_GetSsuDdbFilter(pSiAgentObj, pFilterTask-&gt;argGetSsuDdb.pid, pFilterTask-&gt;argGetSsuDdb.tid, pFilterTask-&gt;argGetSsuDdb.moduleIdMsb );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">//ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span></span><br><span class="line">    <span class="keyword">default</span> :</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里，要拿<code>PMT</code>，要依次跑SEC_FLTR_FUNC_GET_TABLE、SEC_FLTR_FUNC_GET_PMT，</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentVirSecFilterMgr.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SiAgent_Enable_GetTableFilter</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, <span class="keyword">unsigned</span> <span class="keyword">short</span> pid, <span class="keyword">unsigned</span> <span class="keyword">char</span> tid )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    PID_LAYER_P pPidLayer ;</span><br><span class="line">    SEC_FILTER_LAYER_P pSecFilterLayer = <span class="literal">NULL</span>;	<span class="comment">// FIXED_CID_14323</span></span><br><span class="line">    SEC_FILTER_LAYER_T argSecFilter ;</span><br><span class="line">    SEC_FILTER_LAYER_P pSecFilterLinkList ;</span><br><span class="line">    BOOL ret=FALSE;</span><br><span class="line"></span><br><span class="line">    VSFM_LOCK(pSiAgentObj);</span><br><span class="line"></span><br><span class="line">    pPidLayer = SiAgent_VSFM_SearchPidLayer( pSiAgentObj, pid ) ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pPidLayer == <span class="literal">NULL</span> )</span><br><span class="line">    {</span><br><span class="line">        pPidLayer = SiAgent_VSFM_CreatePidLayer( pSiAgentObj, pid ) ;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    argSecFilter.secFilterFunction = SEC_FLTR_FUNC_GET_TABLE ;</span><br><span class="line">    argSecFilter.argGetTable.pid = pid ;</span><br><span class="line">    argSecFilter.argGetTable.tid = tid ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( pPidLayer != <span class="literal">NULL</span> )</span><br><span class="line">    {</span><br><span class="line">        pSecFilterLayer = SiAgent_VSFM_SearchSecFilterLayer( pSiAgentObj, pPidLayer, &amp;argSecFilter ) ;</span><br><span class="line">        <span class="keyword">if</span>( pSecFilterLayer == <span class="literal">NULL</span> )</span><br><span class="line">        {</span><br><span class="line">            pSecFilterLayer = (SEC_FILTER_LAYER_P) VSFM_MALLOC( <span class="keyword">sizeof</span>(SEC_FILTER_LAYER_T) ) ;</span><br><span class="line">            <span class="keyword">if</span>(pSecFilterLayer!=<span class="literal">NULL</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="built_in">memset</span>(pSecFilterLayer,<span class="number">0</span>,<span class="keyword">sizeof</span>(SEC_FILTER_LAYER_T));</span><br><span class="line">                VSFM_FILTER_SET_OWNER(pSecFilterLayer-&gt;owner, SF_OWNER_AGENT);</span><br><span class="line"></span><br><span class="line">                pSecFilterLayer-&gt;referenceCount = <span class="number">1</span> ;</span><br><span class="line">                pSecFilterLayer-&gt;secFilterFunction = SEC_FLTR_FUNC_GET_TABLE ;</span><br><span class="line">                pSecFilterLayer-&gt;argGetTable.pid = pid ;</span><br><span class="line">                pSecFilterLayer-&gt;argGetTable.tid = tid ;</span><br><span class="line"></span><br><span class="line">                pSecFilterLinkList = (SEC_FILTER_LAYER_P) &amp;(pPidLayer-&gt;secFilterLinkList) ;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>( pSecFilterLinkList-&gt;fd == pSecFilterLinkList )</span><br><span class="line">                {</span><br><span class="line">                    pSecFilterLinkList-&gt;fd = pSecFilterLayer ;</span><br><span class="line">                    pSecFilterLinkList-&gt;bk = pSecFilterLayer ;</span><br><span class="line">                    pSecFilterLayer-&gt;fd    = pSecFilterLinkList ;</span><br><span class="line">                    pSecFilterLayer-&gt;bk    = pSecFilterLinkList ;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {</span><br><span class="line">                    pSecFilterLinkList-&gt;bk-&gt;fd = pSecFilterLayer ;</span><br><span class="line">                    pSecFilterLayer-&gt;bk = pSecFilterLinkList-&gt;bk ;</span><br><span class="line">                    pSecFilterLayer-&gt;fd    = pSecFilterLinkList ;</span><br><span class="line">                    pSecFilterLinkList-&gt;bk = pSecFilterLayer ;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                SIAGENT_VSFM_DBG_MSG(DBG_MSG_LEVEL_INFO, <span class="string">"[SiAgent-%s]:SiAgent_Enable_GetTableFilter(pid:0x%04x,tid:0x%02x) - refcnt:%d"</span>,pSiAgentObj-&gt;agentObjectName,pid,tid,pSecFilterLayer-&gt;referenceCount);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            pSecFilterLayer-&gt;referenceCount ++ ;</span><br><span class="line">            SIAGENT_VSFM_DBG_MSG(DBG_MSG_LEVEL_INFO, <span class="string">"[SiAgent-%s]:SiAgent_Enable_GetTableFilter(pid:0x%04x,tid:0x%02x) - refcnt:%d"</span>,pSiAgentObj-&gt;agentObjectName,pid,tid,pSecFilterLayer-&gt;referenceCount);</span><br><span class="line">        }</span><br><span class="line">        ret=TRUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    VSFM_UNLOCK(pSiAgentObj);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>无论哪个secFilterFunction，都会跑SiAgent_VSFM_CreatePidLayer：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siAgentVirSecFilterMgr.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> PID_LAYER_P <span class="title">SiAgent_VSFM_CreatePidLayer</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, <span class="keyword">unsigned</span> <span class="keyword">short</span> pid )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"></span><br><span class="line">    PID_LAYER_P pPidLinkList = (PID_LAYER_P) &amp;(pSiAgentObj-&gt;pidLinkList) ;</span><br><span class="line">    PID_LAYER_P pPidLayer ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    pPidLayer = (PID_LAYER_P) VSFM_MALLOC( <span class="keyword">sizeof</span>(PID_LAYER_T) ) ;</span><br><span class="line">    <span class="keyword">if</span>(pPidLayer!=<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(!SiAgtFW_EnablePidFilter( pSiAgentObj, pid ))</span><br><span class="line">        {</span><br><span class="line">            VSFM_FREE(pPidLayer);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        pPidLayer-&gt;pid = pid ;</span><br><span class="line">        pPidLayer-&gt;secFilterLinkList.fd = &amp;(pPidLayer-&gt;secFilterLinkList) ;</span><br><span class="line">        pPidLayer-&gt;secFilterLinkList.bk = &amp;(pPidLayer-&gt;secFilterLinkList) ;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( pPidLinkList-&gt;fd == pPidLinkList )</span><br><span class="line">        {</span><br><span class="line">            pPidLinkList-&gt;fd = pPidLayer ;</span><br><span class="line">            pPidLinkList-&gt;bk = pPidLayer ;</span><br><span class="line">            pPidLayer-&gt;fd    = pPidLinkList ;</span><br><span class="line">            pPidLayer-&gt;bk    = pPidLinkList ;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            pPidLinkList-&gt;bk-&gt;fd = pPidLayer ;</span><br><span class="line">            pPidLayer-&gt;bk = pPidLinkList-&gt;bk ;</span><br><span class="line">            pPidLayer-&gt;fd    = pPidLinkList ;</span><br><span class="line">            pPidLinkList-&gt;bk = pPidLayer ;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        SiAgtFW_CreateSectionBuffer( pSiAgentObj, pid );</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> pPidLayer ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/agent/siagent2_dvr/siFunctionWrapper.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SiAgtFW_EnablePidFilter</span><span class="params">( SIAGENT_OBJECT_P pSiAgentObj, <span class="keyword">unsigned</span> <span class="keyword">short</span> pid )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(pSiAgentObj-&gt;handleDemuxer)</span><br><span class="line">        <span class="keyword">return</span> SI_TPInterface_SetFilter(pSiAgentObj-&gt;handleDemuxer, pid, SI_FILTER_SI, SI_CODEC_OTHERS) == SI_TP_ERR_OK ? TRUE :FALSE;</span><br><span class="line">    <span class="keyword">return</span> FALSE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/tpInterface/PVR/tp.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_TPInterface_SetFilter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span>								*tp,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						pid,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_FILTER_TYPE						type,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_CODEC_TYPE						codecType</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="keyword">if</span>(type==SI_FILTER_SI)</span><br><span class="line">    {</span><br><span class="line">        ret=SI_BeanGen_EnablePid( _tp-&gt;bgHandle,  pid</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_USE_SDEC</span></span><br><span class="line">                                  ,_tp-&gt;siHandle,_tp-&gt;sdecChannel</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                                );</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    filter.pid			= pid;</span><br><span class="line">    filter.bActive		= <span class="number">1</span>;</span><br><span class="line">    filter.type 		= type;</span><br><span class="line">    filter.codecType	= codecType;</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    _tp-&gt;tsFuncs.InsertFilterList(_tp-&gt;navHandle, count, &amp;filter);</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/tpInterface/PVR/siBeanGen.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_BeanGen_EnablePid</span><span class="params">(BEAN_GENERATOR *pBeanGen,<span class="keyword">unsigned</span> <span class="keyword">int</span> pid</span></span></span><br><span class="line"><span class="params"><span class="function">#ifdef SI_USE_SDEC</span></span></span><br><span class="line"><span class="params"><span class="function">                             ,<span class="keyword">unsigned</span> <span class="keyword">int</span> transaction_id,<span class="keyword">int</span> ch</span></span></span><br><span class="line"><span class="params"><span class="function">#endif</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                            )</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    BEANGEN_FILTERINFO *bgfInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;BEANGEN_FILTERNUM; i++)</span><br><span class="line">    {</span><br><span class="line">        bgfInfo = pBeanGen-&gt;filterInfo+i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(bgfInfo-&gt;pid==pid)</span><br><span class="line">        {</span><br><span class="line">            SI_BEAN_LOG(SI_BEAN_LEVEL_WARNING, <span class="string">"SI_BeanGen_EnablePid re-enable 0x%04x\n"</span>, pid);</span><br><span class="line">            <span class="keyword">return</span> SI_TP_ERR_OK;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;BEANGEN_FILTERNUM; i++)</span><br><span class="line">    {</span><br><span class="line">        bgfInfo = pBeanGen-&gt;filterInfo+i;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(bgfInfo-&gt;pid&gt;<span class="number">0x1fFF</span>)</span><br><span class="line">        {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_USE_SDEC</span></span><br><span class="line">            bgfInfo-&gt;SecfIndex=<span class="number">0xff</span>;</span><br><span class="line">            <span class="keyword">if</span>(ch!=SDEC_CH_MAX)</span><br><span class="line">            {</span><br><span class="line">                SDEC_SECTION_FILTER_T filter;<span class="comment">//={0};</span></span><br><span class="line">                <span class="built_in">memset</span>(&amp;filter,<span class="number">0</span>,<span class="keyword">sizeof</span>(filter));</span><br><span class="line">                filter.pid=pid;</span><br><span class="line">                filter.transaction_id=transaction_id;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_USE_HW_CRC</span></span><br><span class="line">                <span class="keyword">if</span>(PID_TDT!=pid)filter.crc_chksum=<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                <span class="keyword">if</span>(RHAL_SDEC_RequestSection(ch, &amp;filter, &amp;bgfInfo-&gt;SecfIndex, <span class="number">0</span>, fnSDECDataHandlingCB)!=API_OK)</span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">return</span> SI_TP_ERR_BEAN_PID_FULL;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">            bgfInfo-&gt;pid = pid;</span><br><span class="line">            bgfInfo-&gt;tid = <span class="number">0xff</span>;</span><br><span class="line">            bgfInfo-&gt;remainedSecLen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            SI_BEAN_LOG(SI_BEAN_LEVEL_INFO, <span class="string">"SI_BeanGen_EnablePid first-enable 0x%04x\n"</span>, pid);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SI_TP_ERR_OK;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    SI_BEAN_LOG(SI_BEAN_LEVEL_WARNING, <span class="string">"warn!! SI_BeanGen_EnablePid  not enable 0x%04x\n"</span>, pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SI_TP_ERR_BEAN_PID_FULL;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>RHAL_SDEC_RequestSection参数传入了fnSDECDataHandlingCB：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/rtkhal/ \</span></span><br><span class="line"><span class="comment">* hal_src/hal/src/sdec/rhal_sdec.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">DTV_STATUS_T <span class="title">RHAL_SDEC_RequestSection</span><span class="params">(SDEC_CHANNEL_T ch, SDEC_SECTION_FILTER_T *pSectionFilter, UINT8 *pSecfIndex, UINT32 gpbSize, pfnSDECDataHandlingCB pfnCallBack)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SECTION_CALL_DEBUG(RTD_LOG_MODULE_SDEC) ;</span><br><span class="line">    <span class="function">CAutoLock <span class="title">AutoLock</span><span class="params">(&amp;Sdec_CritSec)</span> </span>;</span><br><span class="line">    <span class="function">CAutoLock <span class="title">AutoLockCB</span><span class="params">(&amp;Sdec_CritSecForCB)</span> </span>;</span><br><span class="line">    CHECK_SDEC_MODULE_INIT(<span class="number">0</span>) ;</span><br><span class="line">    CHECK_CH_PARAM_VALID(ch) ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pSectionFilter || !pSecfIndex || !pfnCallBack) <span class="keyword">return</span> INVALID_PARAMS ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DTV_STATUS_T ret ;</span><br><span class="line">    DEMUX_ADD_SEC_FILTER_T secFilter ;</span><br><span class="line">    UINT8 posVal[<span class="number">10</span>]={<span class="number">0</span>}, posMsk[<span class="number">10</span>]={<span class="number">0</span>}, negVal[<span class="number">10</span>]={<span class="number">0</span>}, negMsk[<span class="number">10</span>]={<span class="number">0</span>} ;</span><br><span class="line">    SINT32 secfIndex ;</span><br><span class="line">    UINT8 filterID, i ;</span><br><span class="line">    UINT8 *virAddr ;</span><br><span class="line"></span><br><span class="line">    SECTION_DEBUG(RTD_LOG_MODULE_SDEC, <span class="string">"pid = %d, gpbSize = %d\n"</span>, pSectionFilter-&gt;pid, gpbSize) ;</span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "transaction_id                    = %d\n", pSectionFilter-&gt;transaction_id) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "pid                               = %d\n", pSectionFilter-&gt;pid) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "table_id                          = %d\n", pSectionFilter-&gt;table_id) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "section_syntax_indicator          = %d\n", pSectionFilter-&gt;section_syntax_indicator) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "table_id_extension                = %d\n", pSectionFilter-&gt;table_id_extension) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "version_number                  = %d\n", pSectionFilter-&gt;version_number) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "current_next_indicator            = %d\n", pSectionFilter-&gt;current_next_indicator) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "last_section_number               = %d\n", pSectionFilter-&gt;last_section_number) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "protocol_version                  = %d\n", pSectionFilter-&gt;protocol_version) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "table_id_filter_mask              = %d\n", pSectionFilter-&gt;table_id_filter_mask) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "table_id_extension_filter_mask    = %d\n", pSectionFilter-&gt;table_id_extension_filter_mask) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "section_syntax_indicator_filter   = %d\n", pSectionFilter-&gt;section_syntax_indicator_filter) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "version_number_filter             = %d\n", pSectionFilter-&gt;version_number_filter) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "not_version_number_filter          = %d\n", pSectionFilter-&gt;not_version_number_filter) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "current_next_indicator_filter     = %d\n", pSectionFilter-&gt;current_next_indicator_filter) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "last_section_number_filter        = %d\n", pSectionFilter-&gt;last_section_number_filter) ;</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "protocol_version_filter          = %d\n", pSectionFilter-&gt;protocol_version_filter) ;</span></span><br><span class="line"></span><br><span class="line">    posVal[<span class="number">0</span>] = pSectionFilter-&gt;table_id ;</span><br><span class="line">    posVal[<span class="number">1</span>] = pSectionFilter-&gt;section_syntax_indicator &lt;&lt; <span class="number">7</span> ;</span><br><span class="line">    posVal[<span class="number">2</span>] = <span class="number">0</span> ;</span><br><span class="line">    posVal[<span class="number">3</span>] = pSectionFilter-&gt;table_id_extension &gt;&gt; <span class="number">8</span> ;</span><br><span class="line">    posVal[<span class="number">4</span>] = pSectionFilter-&gt;table_id_extension &amp; <span class="number">0xFF</span> ;</span><br><span class="line">    posVal[<span class="number">5</span>] = pSectionFilter-&gt;version_number &lt;&lt; <span class="number">1</span> | pSectionFilter-&gt;current_next_indicator ;</span><br><span class="line">    posVal[<span class="number">6</span>] = <span class="number">0</span> ; <span class="comment">// map to section_number</span></span><br><span class="line">    posVal[<span class="number">7</span>] = pSectionFilter-&gt;last_section_number ; <span class="comment">// map to last_section_number</span></span><br><span class="line">    posVal[<span class="number">8</span>] = pSectionFilter-&gt;protocol_version ;</span><br><span class="line"></span><br><span class="line">    posMsk[<span class="number">0</span>] = pSectionFilter-&gt;table_id_filter_mask;</span><br><span class="line">    posMsk[<span class="number">1</span>] = (pSectionFilter-&gt;section_syntax_indicator_filter) ? <span class="number">0x80</span> : <span class="number">0x00</span> ;</span><br><span class="line">    posMsk[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    posMsk[<span class="number">3</span>] = pSectionFilter-&gt;table_id_extension_filter_mask &gt;&gt; <span class="number">8</span> ;</span><br><span class="line">    posMsk[<span class="number">4</span>] = pSectionFilter-&gt;table_id_extension_filter_mask &amp; <span class="number">0xFF</span> ;</span><br><span class="line">    posMsk[<span class="number">5</span>] = (((pSectionFilter-&gt;version_number_filter) ? <span class="number">0x1F</span> : <span class="number">0x0</span>) &lt;&lt; <span class="number">1</span>) | ((pSectionFilter-&gt;current_next_indicator_filter) ? <span class="number">0x1</span> : <span class="number">0x0</span>) ;</span><br><span class="line">    posMsk[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">    posMsk[<span class="number">7</span>] = (pSectionFilter-&gt;last_section_number_filter) ? <span class="number">0xFF</span> : <span class="number">0x00</span> ;</span><br><span class="line">    posMsk[<span class="number">8</span>] = (pSectionFilter-&gt;protocol_version_filter) ? <span class="number">0xFF</span>: <span class="number">0x00</span> ;</span><br><span class="line"></span><br><span class="line">    negVal[<span class="number">5</span>] = pSectionFilter-&gt;version_number &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    negMsk[<span class="number">5</span>] = (pSectionFilter-&gt;not_version_number_filter ? <span class="number">0x1F</span> : <span class="number">0x0</span>) &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    secFilter.ch = MAP_TO_DEMUX_CH(ch) ;</span><br><span class="line">    secFilter.param.PID = pSectionFilter-&gt;pid ;</span><br><span class="line">    secFilter.param.crc_en = pSectionFilter-&gt;crc_chksum ;    <span class="comment">// 1: crc; 2: checksum</span></span><br><span class="line">    secFilter.param.one_shoot = pSectionFilter-&gt;once_flag == <span class="number">1</span> ? <span class="number">1</span> : <span class="number">0</span> ;  <span class="comment">// To get section data only once,"1" should be set.</span></span><br><span class="line">    secFilter.param.toggle_mode_en = <span class="number">0</span> ;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for (i = 0 ; i &lt; 10 ; i++)</span></span><br><span class="line"><span class="comment">//    {</span></span><br><span class="line"><span class="comment">//        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "func %s, line %d, posVal[%d] = 0x%x\n", __func__, __LINE__, i, posVal[i]) ;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"><span class="comment">//    for (i = 0 ; i &lt; 10 ; i++)</span></span><br><span class="line"><span class="comment">//    {</span></span><br><span class="line"><span class="comment">//        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "func %s, line %d, posMsk[%d] = 0x%x\n", __func__, __LINE__, i, posMsk[i]) ;</span></span><br><span class="line"><span class="comment">//    }</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, "pid %d, crc_chksum %d, once_flag %d\n", pSectionFilter-&gt;pid, pSectionFilter-&gt;crc_chksum, pSectionFilter-&gt;once_flag) ;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;secFilter.param.PosVal, posVal, <span class="keyword">sizeof</span>(secFilter.param.PosVal)) ;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;secFilter.param.PosMsk, posMsk, <span class="keyword">sizeof</span>(secFilter.param.PosMsk)) ;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;secFilter.param.NegVal, negVal, <span class="keyword">sizeof</span>(secFilter.param.NegVal)) ;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;secFilter.param.NegMsk, negMsk, <span class="keyword">sizeof</span>(secFilter.param.NegMsk)) ;</span><br><span class="line"></span><br><span class="line">    secFilter.size = gpbSize; <span class="comment">/* decide how many size of buffer for this section */</span></span><br><span class="line"></span><br><span class="line">    CHECK_IOCTL_RESULT(KADP_SDEC_SetGetProperty(DEMUX_PROPERTY_ADD_SECTION_FILTER, (<span class="keyword">void</span> *)&amp;secFilter, &amp;secfIndex)) ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SDEC_CALLBACK_T *pSec        = &amp;Sdec_Info.stSection[MAP_TO_DEMUX_CH(ch)][secfIndex] ;</span><br><span class="line">    RINGBUFFER_HEADER *pHeader = (RINGBUFFER_HEADER *)(Sdec_Info.bufferHeaderPoll.virAddr + (secFilter.headerPhyAddr - (UINT32)Sdec_Info.bufferHeaderPoll.phyAddr));</span><br><span class="line"></span><br><span class="line">    pSec-&gt;phyAddrOffset = Sdec_Info.secBufferInfo.phyAddrOffset;</span><br><span class="line">    pSec-&gt;pWrPtr        = &amp;pHeader-&gt;writePtr;</span><br><span class="line">    pSec-&gt;pRdPtr        = &amp;pHeader-&gt;readPtr[<span class="number">0</span>];</span><br><span class="line">    pSec-&gt;pRdTmpPtr     = &amp;pHeader-&gt;readPtr[<span class="number">1</span>];</span><br><span class="line">    pSec-&gt;pBufferLower  = (UINT8 *)pHeader-&gt;beginAddr;</span><br><span class="line">    pSec-&gt;pBufferUpper  = pSec-&gt;pBufferLower + pHeader-&gt;size;</span><br><span class="line"></span><br><span class="line">    pSec-&gt;pfnCallBack           = pfnCallBack ;</span><br><span class="line">    pSec-&gt;msgType.msgId         = <span class="number">0x67301</span> ;   <span class="comment">//  MSG_SDEC2SIPSIP_SECTION_ACQUIRED ;</span></span><br><span class="line">    pSec-&gt;msgType.channel       = ch ;</span><br><span class="line">    pSec-&gt;msgType.filterId      = secfIndex ;</span><br><span class="line">    pSec-&gt;msgType.pid           = pSectionFilter-&gt;pid ;</span><br><span class="line">    pSec-&gt;msgType.transactionId = pSectionFilter-&gt;transaction_id ;</span><br><span class="line">    pSec-&gt;msgType.pData         = <span class="number">0</span> ;</span><br><span class="line">    pSec-&gt;msgType.dataLen       = <span class="number">0</span> ;</span><br><span class="line">    pSec-&gt;msgType.tableType     = pSectionFilter-&gt;table_id ;   <span class="comment">// ONLY for PSIP</span></span><br><span class="line">    pSec-&gt;msgType.entryId       = <span class="number">0</span> ;   <span class="comment">// ONLY for PSIP</span></span><br><span class="line">    pSec-&gt;msgType.bufLower      = (UINT32)pSec-&gt;pBufferLower + pSec-&gt;phyAddrOffset;</span><br><span class="line">    pSec-&gt;msgType.bufUpper      = pSec-&gt;msgType.bufLower + pHeader-&gt;size;</span><br><span class="line">    *pSecfIndex                 = secfIndex ;</span><br><span class="line">    pSec-&gt;used                  = <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">    SECTION_DEBUG(RTD_LOG_MODULE_SDEC, <span class="string">"phyAddrOfSet 0x%x, pWrPtr 0x%x, pRdPtr 0x%x\n"</span>, pSec-&gt;phyAddrOffset, pSec-&gt;pWrPtr, pSec-&gt;pRdPtr) ;</span><br><span class="line">    SECTION_DEBUG(RTD_LOG_MODULE_SDEC, <span class="string">"*pWrPtr 0x%x, *pRdPtr 0x%x, *pRdTmpPtr 0x%x\n"</span>, *pSec-&gt;pWrPtr, *pSec-&gt;pRdPtr, *pSec-&gt;pRdTmpPtr) ;</span><br><span class="line">    SECTION_DEBUG(RTD_LOG_MODULE_SDEC, <span class="string">"pBufferLower 0x%x, pBufferUpper 0x%x, gpbSize %d\n"</span>, pSec-&gt;pBufferLower, pSec-&gt;pBufferUpper, gpbSize) ;</span><br><span class="line">    SECTION_DEBUG(RTD_LOG_MODULE_SDEC, <span class="string">"secfIndex = %d\n"</span>, secfIndex) ;</span><br><span class="line">    <span class="keyword">return</span> API_OK ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>到这里好像就没了？<code>PMT</code>信息好像还是没有拿到呢？</p>
<h2 id="SDEC-Thread"><a href="#SDEC-Thread" class="headerlink" title="_SDEC_Thread"></a>_SDEC_Thread</h2><p>小<span class="github-emoji"><span>🔥</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f525.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>汁还是太年轻了，这里有另外一个线程_SDEC_Thread要说明一下。</p>
<p>从TVservice启动的时候开始：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/services/ \</span></span><br><span class="line"><span class="comment">* tvservice/main_tvservice.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc __attribute__((unused)), <span class="keyword">char</span> **argv __attribute__((unused)))</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    BootManager::<span class="built_in">GetInstance</span>()-&gt;<span class="built_in">Initial</span>();</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* BootManager/BootManager.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">BootManager::Initial</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">return</span> m_pBootManagerImpl-&gt;<span class="built_in">Initial</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* BootManager/BootManagerImpl.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">BootManagerImpl::Initial</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="built_in">RegisterInitFunc</span>();</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BootManagerImpl::RegisterInitFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    m_pInitFuncImplMgr-&gt;<span class="built_in">RegisterInitFunc</span>(&amp;BootManagerImpl::InitDTV, INIT_PRIORITY_3, INIT_MODULE_DTV);</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">BootManagerImpl::InitDTV</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">DUMP_TRACE_LOG</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_TUNNERCHECK</span></span><br><span class="line">	<span class="keyword">if</span> (m_bWithTuner)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	{</span><br><span class="line">		m_pHalModulesInit = <span class="keyword">new</span> <span class="built_in">HalModulesInit</span>();</span><br><span class="line">	}</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/rtkhal/ \</span></span><br><span class="line"><span class="comment">* hal_src/hal/src/hal_module_manager/HalModulesInit.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">HalModulesInit::<span class="built_in">HalModulesInit</span>()</span><br><span class="line">{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">RHAL_SDEC_InitializeModule</span>()!=API_OK)</span><br><span class="line">        <span class="built_in">ALOGE</span>(<span class="string">"[%s %d] RHAL_SDEC_InitializeModule fails\n"</span>, __func__, __LINE__);</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/rtkhal/ \</span></span><br><span class="line"><span class="comment">* hal_src/hal/src/sdec/rhal_sdec.cpp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">DTV_STATUS_T <span class="title">RHAL_SDEC_InitializeModule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">RTD_LOGGER_CALL</span>(RTD_LOG_MODULE_SDEC) ;</span><br><span class="line">    <span class="keyword">return</span> _Initiallize() ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> DTV_STATUS_T _Initiallize()</span><br><span class="line">{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="comment">// Create SDEC thread</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">pthread_create</span>(&amp;_sdec_thread_id, <span class="literal">NULL</span>, _SDEC_Thread, <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">RTD_LOG_ERROR</span>(RTD_LOG_MODULE_SDEC, <span class="string">"[%s %d] %s - SDEC thread creation failed\n"</span>, __FILE__, __LINE__, __func__) ;</span><br><span class="line">        <span class="keyword">return</span> API_NOT_OK ;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        _isRunSdecThread = <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">    Sdec_IsInit = <span class="number">1</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> API_OK ;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *_SDEC_Thread(<span class="keyword">void</span>*)</span><br><span class="line">{</span><br><span class="line"><span class="comment">// check error for debug</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID(index, size, buffer_info, msg)     \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (index &gt;= Sdec_Info.secBufferInfo.maxIndex || size &gt; MAX_SECTION_SIZE)              \</span></span><br><span class="line"><span class="meta">    {                                                                                      \</span></span><br><span class="line"><span class="meta">        RTD_LOG_ERROR(RTD_LOG_MODULE_SDEC,<span class="meta-string">"func %s, line %d, Please Debug !! index %d, size %d\n"</span>, __func__, __LINE__, (index), (size));                                                                                           \</span></span><br><span class="line"><span class="meta">        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, <span class="meta-string">"Before clean section buffer : TmpRd 0x%x, Wr 0x%x, pLower 0x%x, pUpper 0x%x\n"</span>, (buffer_info).pRdTmpPtr,(buffer_info).pWrPtr, (buffer_info).pBufferLower, (buffer_info).pBufferUpper); \</span></span><br><span class="line"><span class="meta">        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, <span class="meta-string">"Before clean section buffer : Sectiondata    CH: %d PID:0x%x - tid:0x%x \n"</span>, (msg).channel, (msg).pid, (msg).tableType);                                                               \</span></span><br><span class="line"><span class="meta">        (buffer_info).pRdTmpPtr = (buffer_info).pWrPtr;                                    \</span></span><br><span class="line"><span class="meta">        (buffer_info).pRdPtr    = (buffer_info).pWrPtr;                                    \</span></span><br><span class="line"><span class="meta">        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, <span class="meta-string">"After clean section buffer : TmpRd 0x%x, Wr 0x%x, pLower 0x%x, pUpper 0x%x\n"</span>, (buffer_info).pRdTmpPtr,(buffer_info).pWrPtr, (buffer_info).pBufferLower, (buffer_info).pBufferUpper);  \</span></span><br><span class="line"><span class="meta">        RTD_LOG_DEBUG(RTD_LOG_MODULE_SDEC, <span class="meta-string">"After clean section buffer : Sectiondata     CH: %d PID:0x%x - tid:0x%x \n"</span>, (msg).channel, (msg).pid, (msg).tableType);                                                               \</span></span><br><span class="line"><span class="meta">        Sdec_CritSecForCB.Unlock();                                                        \</span></span><br><span class="line"><span class="meta">        continue;                                                                          \</span></span><br><span class="line"><span class="meta">    }</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* threadName = <span class="string">"SdecThread"</span>;</span><br><span class="line">    <span class="built_in">pli_setThreadName</span>((<span class="keyword">char</span>*)threadName) ;</span><br><span class="line">    SDEC_MSG_TYPE_T msgType ;</span><br><span class="line">    SINT32 i, j, index, size;</span><br><span class="line">    UINT32 r;</span><br><span class="line">    UINT8 *ptr, *pVirAddr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span> ;</span></span><br><span class="line">    SDEC_CALLBACK_T *pCB;</span><br><span class="line">    fds.fd = Sdec_Info.fd ;</span><br><span class="line">    fds.events = POLLIN ; <span class="comment">// the input event</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;msgType, <span class="number">0x0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(SDEC_MSG_TYPE_T)) ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">poll</span>(&amp;fds, <span class="number">1</span>, POLL_INTERVAL) &gt; <span class="number">0</span>)  <span class="comment">// wait POLL_INTERVAL ms</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (fds.revents &amp; POLLIN) <span class="comment">// the output event</span></span><br><span class="line">            {</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Section */</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; DEMUX_CH_NUM ; i++)</span><br><span class="line">                {</span><br><span class="line">                    <span class="keyword">for</span> (j = <span class="number">0</span> ; j &lt; MAX_SECTION_NUM ; j++)</span><br><span class="line">                    {</span><br><span class="line">                        pCB = &amp;Sdec_Info.stSection[i][j] ;</span><br><span class="line">                        Sdec_CritSecForCB.<span class="built_in">Lock</span>();</span><br><span class="line">                        <span class="comment">/* check if new section is coming */</span></span><br><span class="line">                        <span class="keyword">if</span> (pCB-&gt;used &amp;&amp; pCB-&gt;pRdPtr &amp;&amp; <span class="built_in">BS_DISTANCE_TO_READ</span>(*pCB-&gt;pRdTmpPtr, *pCB-&gt;pWrPtr, pCB-&gt;pBufferLower, pCB-&gt;pBufferUpper) &gt; <span class="number">4</span>)</span><br><span class="line">                        {</span><br><span class="line">                            ptr = (UINT8 *)(*pCB-&gt;pRdTmpPtr);</span><br><span class="line">                            pVirAddr = ptr + pCB-&gt;phyAddrOffset;</span><br><span class="line">                            r = *(UINT32 *)pVirAddr ;</span><br><span class="line">                            index = r &gt;&gt; <span class="number">16</span> ;        <span class="comment">/* the section data belong to number of section chunk */</span></span><br><span class="line">                            size  = r &amp; <span class="number">0xffff</span> ;     <span class="comment">/* section data size, if size is 0, index indicates its location */</span></span><br><span class="line"><span class="comment">//                            RTD_LOG_ERROR(RTD_LOG_MODULE_SDEC,"func %s, line %d, ptr 0x%x, index %d, size %d\n", __func__, __LINE__, ptr, index, size) ;</span></span><br><span class="line"></span><br><span class="line">                            <span class="built_in">CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID</span>(index, size, *pCB, msgType);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!size) <span class="comment">/* jump to next index */</span></span><br><span class="line">                            {</span><br><span class="line">                                ptr      = Sdec_Info.secBufferInfo.phyAddr + SDEC_EACH_SEC_UNIT_SIZE*index ; <span class="comment">/* physical address */</span></span><br><span class="line">                                pVirAddr = ptr + pCB-&gt;phyAddrOffset ; <span class="comment">/* virtual address */</span></span><br><span class="line">                                size     = (*(UINT32 *)pVirAddr) &amp; <span class="number">0xffff</span> ;</span><br><span class="line">                                index    = (*(UINT32 *)pVirAddr) &gt;&gt; <span class="number">16</span> ;</span><br><span class="line"><span class="comment">//                                RTD_LOG_ERROR(RTD_LOG_MODULE_SDEC,"func %s, line %d, ptr 0x%x, index %d, size %d\n", __func__, __LINE__, ptr, index, size) ;</span></span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID</span>(index, size, *pCB, msgType);</span><br><span class="line"></span><br><span class="line">                            ptr +=<span class="number">4</span> ; <span class="comment">/* move to data address, first 4 bytes is (index, size) */</span></span><br><span class="line">                            <span class="built_in">memcpy</span>(&amp;msgType, &amp;pCB-&gt;msgType, <span class="built_in"><span class="keyword">sizeof</span></span>(SDEC_MSG_TYPE_T)) ;</span><br><span class="line">                            msgType.pData = ptr + Sdec_Info.secBufferInfo.phyAddrOffset;</span><br><span class="line">                            msgType.dataLen = size ;</span><br><span class="line">                           *pCB-&gt;pRdTmpPtr = ((ULONG)(ptr) + size + <span class="number">3</span>) &amp; ~<span class="number">0x3</span> ; <span class="comment">/* move to next section */</span></span><br><span class="line">                            <span class="built_in">SECTION_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"[%s %d] %s - section filter id_%d callback\n"</span>, __FILE__, __LINE__, __func__, msgType.filterId) ;</span><br><span class="line">                            <span class="built_in">KADP_SDEC_DEBUG_INFO</span>(msgType.pid,SDEC_DEBUG_LOG_CONTROL_CALLBACK, <span class="string">"Sectiondata1     CH: %d    PID:0x%x - tid:0x%x, [0x%x](%s) DataLen:%d\n"</span>, msgType.channel, msgType.pid, msgType.tableType, <span class="number">0</span>,<span class="string">"------"</span> ,msgType.dataLen);</span><br><span class="line">                            Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line"></span><br><span class="line">                            pCB-&gt;<span class="built_in">pfnCallBack</span>(&amp;msgType) ;</span><br><span class="line"></span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(pCB-&gt;used &amp;&amp; msgType.pData &amp;&amp; pCB-&gt;msgType.msgId==<span class="number">0x67401</span>&amp;&amp;j==MAX_SECTION_NUM<span class="number">-1</span>){</span><br><span class="line">                            <span class="built_in">memcpy</span>(&amp;msgType, &amp;pCB-&gt;msgType, <span class="built_in"><span class="keyword">sizeof</span></span>(SDEC_MSG_TYPE_T)) ;</span><br><span class="line">                            <span class="keyword">int</span> ret = <span class="built_in">KADP_SDEC_GetPCRAdaptionField</span>((DEMUX_CHANNEL_T)msgType.channel,msgType.pid,msgType.pData,&amp;msgType.dataLen);</span><br><span class="line">                            Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line">                            <span class="built_in">RTD_LOG_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"_SDEC_Thread get pcr ret=%d\n"</span>, ret); </span><br><span class="line">                            <span class="keyword">if</span>(ret ==<span class="number">0</span>){</span><br><span class="line">                                <span class="built_in">RTD_LOG_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"_SDEC_Thread get pcr dataLen=%d data=%02x %02x %02x %02x  \n"</span>, msgType.dataLen,msgType.pData[<span class="number">0</span>],msgType.pData[<span class="number">1</span>],msgType.pData[<span class="number">2</span>],msgType.pData[<span class="number">3</span>]); </span><br><span class="line">                                pCB-&gt;<span class="built_in">pfnCallBack</span>(&amp;msgType) ;</span><br><span class="line">                            }</span><br><span class="line">                        }<span class="keyword">else</span>{</span><br><span class="line">                            Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* PES */</span></span><br><span class="line">                <span class="keyword">for</span> (i = <span class="number">0</span> ; i &lt; DEMUX_CH_NUM ; i++)</span><br><span class="line">                        {</span><br><span class="line">                    <span class="keyword">for</span> (j = <span class="number">0</span> ; j &lt; MAX_PES_NUM ; j++)</span><br><span class="line">                            {</span><br><span class="line">                        pCB = &amp;Sdec_Info.stPes[i][j];</span><br><span class="line">                        Sdec_CritSecForCB.<span class="built_in">Lock</span>();</span><br><span class="line">                        <span class="keyword">if</span> (pCB-&gt;used &amp;&amp; pCB-&gt;status == DEMUX_PESBUFFER_OP_PENDING_FOR_INIT){</span><br><span class="line">                            <span class="keyword">if</span> (*(pCB-&gt;pReserved2)==DEMUX_PESBUFFER_OP_INITIALIZED){</span><br><span class="line">                                pCB-&gt;status = DEMUX_PESBUFFER_OP_INITIALIZED;</span><br><span class="line"></span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">else</span>{</span><br><span class="line">                                Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">if</span> (pCB-&gt;pRdPtr)</span><br><span class="line">                        {</span><br><span class="line">                            <span class="built_in">RTD_LOG_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"Rd 0x%x, Wr 0x%x, pLower 0x%x, pUpper 0x%x\n"</span>, *pCB-&gt;pRdTmpPtr, *pCB-&gt;pWrPtr, pCB-&gt;pBufferLower, pCB-&gt;pBufferUpper) ;</span><br><span class="line">                        }</span><br><span class="line"></span><br><span class="line">                        <span class="comment">/* check if new PES is coming */</span></span><br><span class="line">                        <span class="keyword">if</span> (pCB-&gt;used &amp;&amp; pCB-&gt;pRdPtr &amp;&amp; <span class="built_in">BS_DISTANCE_TO_READ</span>(*pCB-&gt;pRdTmpPtr, *pCB-&gt;pWrPtr, pCB-&gt;pBufferLower, pCB-&gt;pBufferUpper) &gt; <span class="number">4</span>)</span><br><span class="line">                        {</span><br><span class="line">                            ptr = (UINT8 *)(*pCB-&gt;pRdTmpPtr);</span><br><span class="line">                            pVirAddr = ptr + pCB-&gt;phyAddrOffset;</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">memcpy</span>(&amp;msgType, &amp;pCB-&gt;msgType, <span class="built_in"><span class="keyword">sizeof</span></span>(SDEC_MSG_TYPE_T)) ;</span><br><span class="line">                            <span class="comment">/* get PES size */</span></span><br><span class="line">                            UINT8 *pPesStart = ptr;</span><br><span class="line">                            size = <span class="number">0</span>;</span><br><span class="line">                            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; DEMUX_PESDATA_PREFIX_PESLENGTH; i++)</span><br><span class="line">                            {</span><br><span class="line">                                size += *(pPesStart + pCB-&gt;phyAddrOffset) &lt;&lt; (i &lt;&lt; <span class="number">3</span>);</span><br><span class="line">                                <span class="keyword">if</span> ((pPesStart + <span class="number">1</span>) &gt;= pCB-&gt;pBufferUpper) <span class="comment">/* move to base */</span></span><br><span class="line">                                    pPesStart = pCB-&gt;pBufferLower;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    pPesStart++;</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                            <span class="comment">/* move to data address (first DEMUX_PESDATA_PREFIX_PESLENGTH bytes is size) */</span></span><br><span class="line"></span><br><span class="line">                            ptr +=DEMUX_PESDATA_PREFIX_PESLENGTH;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (ptr &gt;= pCB-&gt;pBufferUpper)</span><br><span class="line">                            {</span><br><span class="line">                                ptr -= (pCB-&gt;pBufferUpper - pCB-&gt;pBufferLower);</span><br><span class="line">                            }</span><br><span class="line"></span><br><span class="line">                            msgType.pData = ptr + pCB-&gt;phyAddrOffset;</span><br><span class="line">                            msgType.dataLen = size ;</span><br><span class="line"></span><br><span class="line">                            ptr += size; <span class="comment">/* move to next PES */</span></span><br><span class="line">                            <span class="keyword">if</span> (ptr &gt;= pCB-&gt;pBufferUpper)</span><br><span class="line">                            {</span><br><span class="line">                                ptr -= (pCB-&gt;pBufferUpper - pCB-&gt;pBufferLower);</span><br><span class="line">                            }</span><br><span class="line">                           *pCB-&gt;pRdTmpPtr = (ULONG)(ptr) ; <span class="comment">/* move to next PES */</span></span><br><span class="line"></span><br><span class="line">                            <span class="built_in">RTD_LOG_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"[%s %d] %s - pes filter id_%d callback, ptr 0x%x, size %d\n"</span>, __FILE__, __LINE__, __func__, msgType.filterId, msgType.pData, msgType.dataLen) ;</span><br><span class="line">                            <span class="built_in">KADP_SDEC_DEBUG_INFO</span>(msgType.pid,SDEC_DEBUG_LOG_CONTROL_CALLBACK, <span class="string">"PESdata          CH: %d    PID:0x%x -tid: 0x%x, [0x%x](%s) DataLen:%d\n"</span>,</span><br><span class="line">                                msgType.channel, msgType.pid, <span class="number">0</span>, <span class="number">0</span>, <span class="string">"------"</span> ,msgType.dataLen);</span><br><span class="line"></span><br><span class="line">                            Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line">                            pCB-&gt;<span class="built_in">pfnCallBack</span>(&amp;msgType) ;</span><br><span class="line"></span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        {</span><br><span class="line">                            Sdec_CritSecForCB.<span class="built_in">Unlock</span>();</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(!_isRunSdecThread)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">RTD_LOG_DEBUG</span>(RTD_LOG_MODULE_SDEC, <span class="string">"[%s %d] %s - Exit _SDEC_Thread\n"</span>, __FILE__, __LINE__, __func__) ;</span><br><span class="line">            <span class="keyword">break</span> ;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> CONTINUE_LOOP_IF_SECTION_BUFFER_INFO_IS_INVALID</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>开机之后，TVservice就有一个_SDEC_Thread在跑，其中的while(1)循环里Section部分，会check if new section is coming。_</p>
<p>前面分析，扫台线程ScanThread Check SI的时候，也就是si_agent_threadfuntion SI_AGENT_STATUS_RUNNING的时候，最后行为是在RHAL_SDEC_RequestSection，其中的</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pSec-&gt;pfnCallBack           = pfnCallBack ;</span><br></pre></td></tr></tbody></table></figure>

<p>声明了函数指针。</p>
<p>所以这个_SDEC_Thread检测到有section来临时，会跑这个回调函数咯：</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pCB-&gt;<span class="built_in">pfnCallBack</span>(&amp;msgType) ;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/collector/SI_Collector.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function">DTV_STATUS_T <span class="title">fnSDECDataHandlingCB</span><span class="params">(SDEC_MSG_TYPE_T *pMsg)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(pMsg!=<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        SI *pSI=(SI*)pMsg-&gt;transactionId;</span><br><span class="line">        <span class="keyword">if</span>(pSI!=<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span>	section[<span class="number">4096</span>];</span><br><span class="line">            <span class="keyword">if</span>(pMsg-&gt;dataLen&lt;=<span class="number">4096</span>)</span><br><span class="line">            {</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> SI_SDEC_SIMULATE</span></span><br><span class="line">                si_collector_copy_section(pSI-&gt;collector,pSI-&gt;db,pMsg-&gt;dataLen,pMsg-&gt;pData,pMsg-&gt;pid);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line">                RHAL_SDEC_CopySectionData(pMsg-&gt;channel,pMsg-&gt;filterId,pMsg-&gt;pid,section,pMsg-&gt;pData,pMsg-&gt;dataLen);</span><br><span class="line">                <span class="comment">//RHAL_SDEC_ReturnSectionBuffer(pMsg-&gt;channel, pMsg-&gt;filterId, pMsg-&gt;pid, pMsg-&gt;pData, pMsg-&gt;dataLen);</span></span><br><span class="line">                pthread_mutex_lock(&amp;pSI-&gt;collector-&gt;mutexSectionFilter);<span class="comment">//#ifdef ENABLE_MHEG5, fix not thread safe</span></span><br><span class="line">                si_collector_copy_section(pSI-&gt;collector,pSI-&gt;db,pMsg-&gt;dataLen,section,pMsg-&gt;pid);</span><br><span class="line">                pthread_mutex_unlock(&amp;pSI-&gt;collector-&gt;mutexSectionFilter);<span class="comment">//#ifdef ENABLE_MHEG5, fix not thread safe</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> API_OK;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">si_collector_copy_section</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_COLLECTOR							*pCollector,</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_DATABASE							*pDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						sectionLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span>						*sectionBuf,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> pid</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line"></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">char</span> tid = sectionBuf[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">short</span> tidEx;</span><br><span class="line">        SI_Database_Lock(pDatabase);</span><br><span class="line">        SI_Database_InsertSection(pDatabase, sectionLength, sectionBuf, pid);</span><br><span class="line">        SI_Database_Unlock(pDatabase);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _SI_EXPORT_SECTION_FILTER</span></span><br><span class="line">        <span class="keyword">if</span>( err != SI_ERR_CRC_ERROR ) {</span><br><span class="line">            <span class="comment">//ps. SI_Callback_Section "should" check crc when send it out</span></span><br><span class="line">            <span class="keyword">if</span>( pCollector-&gt;sectionCB[SI_SECTIONCOLLECTOR_CBF_TYPE_CUSTOMIZED_SECTION] != <span class="literal">NULL</span>)</span><br><span class="line">                pCollector-&gt;sectionCB[SI_SECTIONCOLLECTOR_CBF_TYPE_CUSTOMIZED_SECTION](pDatabase, sectionLength, &amp;sectionBuf, pid);</span><br><span class="line">        }</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">//_SI_EXPORT_SECTION_FILTER</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span><br><span class="line">        <span class="comment">//kjw ssu todo: need to check crc</span></span><br><span class="line">        <span class="keyword">if</span>( tid == SI_TID_DSM_DXI || tid == SI_TID_DSM_DDB || tid == SI_SSU_UNT)</span><br><span class="line">        {</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pCollector-&gt;sectionCB[SI_SECTIONCOLLECTOR_CBF_TYPE_SSU_SECTION])</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span>(sectionLength &gt;=<span class="number">30</span>)</span><br><span class="line">                {   <span class="comment">// min length of ddb,dXi is 30</span></span><br><span class="line">                    <span class="comment">//crc is checked in individual table</span></span><br><span class="line">                    pCollector-&gt;sectionCB[SI_SECTIONCOLLECTOR_CBF_TYPE_SSU_SECTION](pDatabase, sectionLength, &amp;sectionBuf, pid);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span><span class="comment">//ENABLE_SYSTEM_SOFTWARE_UPDATE</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                if (pCollector-&gt;sorted_sectionFilterCb==0) {</span></span><br><span class="line"><span class="comment">                    //sort callback pointer by desc.</span></span><br><span class="line"><span class="comment">                    qsort(pCollector-&gt;sectionFilterCb, SI_COLLECTION_CALLBACK_MAX, sizeof(SI_COLLECTOR_SECTION_FILTER_CALLBACK), compare_SI_COLLECTOR_SECTION_FILTER_CALLBACK);</span></span><br><span class="line"><span class="comment">                    pCollector-&gt;sorted_sectionFilterCb=1;</span></span><br><span class="line"><span class="comment">                }</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;SI_COLLECTION_CALLBACK_MAX; i++) {</span><br><span class="line">            SI_COLLECTOR_SECTION_FILTER_CALLBACK *pSectionFilterCb;</span><br><span class="line">            SI_Collector_SectionCallbackEx pCallback;</span><br><span class="line">            SI_Collector_SectionCallbackEx_userdata pCallback_userdata;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            pSectionFilterCb=&amp;pCollector-&gt;sectionFilterCb[i];</span><br><span class="line">            <span class="keyword">if</span> (pSectionFilterCb-&gt;pCallback==<span class="literal">NULL</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (pid!=pSectionFilterCb-&gt;pid)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (pSectionFilterCb-&gt;pid==pid &amp;&amp;</span><br><span class="line">                    ((pSectionFilterCb-&gt;tid==(<span class="keyword">unsigned</span> <span class="keyword">short</span>)<span class="number">-1</span>) || ((pSectionFilterCb-&gt;tid&amp;pSectionFilterCb-&gt;tidMask)==(tid&amp;pSectionFilterCb-&gt;tidMask))) <span class="comment">//#ifdef ENABLE_MHEG5, for OB SSF api(for receive 0x3B/0x3C/0x3D data in one section filter)</span></span><br><span class="line">               ) {</span><br><span class="line">                <span class="keyword">if</span> (pSectionFilterCb-&gt;tidEx!=(<span class="keyword">unsigned</span> <span class="keyword">short</span>)<span class="number">-1</span> &amp;&amp;</span><br><span class="line">                        SI_IS_ISDB_T(pDatabase-&gt;si) &amp;&amp;</span><br><span class="line">                        (tid==SI_TID_DSM_DDB ||</span><br><span class="line">                         tid==SI_TID_DSM_DXI||</span><br><span class="line">                         tid==SI_TID_DSM_3E ||</span><br><span class="line">                         tid==SI_TID_DSM_3D||</span><br><span class="line">                         tid==SI_TID_DSM_3A||</span><br><span class="line">                         tid==SI_TID_DSM_3F )</span><br><span class="line">                   ) {</span><br><span class="line">                    <span class="comment">//ETSI TR 101 202 V1.2.1 Table B.1</span></span><br><span class="line">                    <span class="keyword">if</span> (sectionLength&gt;=<span class="number">5</span>) {</span><br><span class="line">                        tidEx = (<span class="keyword">unsigned</span> <span class="keyword">short</span>)((<span class="keyword">unsigned</span> <span class="keyword">short</span>)(sectionBuf[<span class="number">3</span>])&lt;&lt;<span class="number">8</span>|sectionBuf[<span class="number">4</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (tidEx==pSectionFilterCb-&gt;tidEx) {</span><br><span class="line">                            <span class="keyword">if</span> (pSectionFilterCb-&gt;callback_index==SI_Collector_SectionCallbackEx_INDEX_0)</span><br><span class="line">                            {</span><br><span class="line">                                pCallback=pSectionFilterCb-&gt;pCallback;</span><br><span class="line">                                pthread_mutex_unlock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                                pCallback(pSectionFilterCb-&gt;user_data, sectionLength, &amp;sectionBuf, pid,tid,tidEx,<span class="literal">false</span>);</span><br><span class="line">                                pthread_mutex_lock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line"></span><br><span class="line">                            }</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            {</span><br><span class="line">                                pCallback_userdata=pSectionFilterCb-&gt;pCallback_userdata;</span><br><span class="line">                                pthread_mutex_unlock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                                pCallback_userdata(pSectionFilterCb-&gt;user_data, sectionLength, &amp;sectionBuf, pid,tid,tidEx,<span class="literal">false</span>,pSectionFilterCb-&gt;user_data_len);</span><br><span class="line">                                pthread_mutex_lock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                            }</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    tidEx=<span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">if</span>(pSectionFilterCb-&gt;tidEx!=(<span class="keyword">unsigned</span> <span class="keyword">short</span>)<span class="number">-1</span> &amp;&amp; sectionLength&gt;=<span class="number">5</span>)</span><br><span class="line">                    {</span><br><span class="line">                        tidEx = (<span class="keyword">unsigned</span> <span class="keyword">short</span>)((<span class="keyword">unsigned</span> <span class="keyword">short</span>)(sectionBuf[<span class="number">3</span>])&lt;&lt;<span class="number">8</span>|sectionBuf[<span class="number">4</span>]);</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">if</span>(pSectionFilterCb-&gt;tidEx == tidEx)</span><br><span class="line">                    {</span><br><span class="line">                        <span class="keyword">if</span> (pSectionFilterCb-&gt;callback_index==SI_Collector_SectionCallbackEx_INDEX_0)</span><br><span class="line">                        {</span><br><span class="line">                            pCallback=pSectionFilterCb-&gt;pCallback;</span><br><span class="line">                            pthread_mutex_unlock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                            pCallback(pSectionFilterCb-&gt;user_data, sectionLength, &amp;sectionBuf, pid,tid,tidEx,<span class="literal">false</span>);</span><br><span class="line">                            pthread_mutex_lock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                        }</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                        {</span><br><span class="line">                            pCallback_userdata=pSectionFilterCb-&gt;pCallback_userdata;</span><br><span class="line">                            pthread_mutex_unlock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                            pCallback_userdata(pSectionFilterCb-&gt;user_data, sectionLength, &amp;sectionBuf, pid,tid,tidEx,<span class="literal">false</span>,pSectionFilterCb-&gt;user_data_len);</span><br><span class="line">                            pthread_mutex_lock(&amp;pCollector-&gt;mutexSectionFilter);</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* vendor/realtek/frameworks/native/appclass/ \</span></span><br><span class="line"><span class="comment">* Si/liveTV_SiDvb/librtd/si4/database/SI_DatabaseSection.c</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">ErrCode <span class="title">SI_Database_InsertSection</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_DATABASE							*pDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						sectionLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span>						*sectionRawBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span> 						pid</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    <span class="keyword">switch</span>(tid)</span><br><span class="line">    {</span><br><span class="line">    <span class="keyword">case</span> SI_TID_PAT:</span><br><span class="line">        <span class="keyword">if</span> (pid==PID_PAT)</span><br><span class="line">            err = si_database_insert_pat(pDatabase, sectionLength, sectionRawBuffer);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SI_TID_CAT:</span><br><span class="line">        <span class="keyword">if</span> (pid==PID_CAT)</span><br><span class="line">            err = si_database_insert_cat(pDatabase, sectionLength, sectionRawBuffer);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SI_TID_PMT:</span><br><span class="line">        err = si_database_insert_pmt(pDatabase, sectionLength, sectionRawBuffer,pid);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">//省略代码段</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        err = SI_ERR_SECTION_NOT_CHECKED;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//省略代码段</span></span><br><span class="line">    SI_DB_RETURN(err);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ErrCode <span class="title">si_database_insert_pmt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    SI_DATABASE							*pDatabase,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">int</span>						sectionLength,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">char</span>						*sectionRawBuffer,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">short</span> pid</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    SI_DATABASE_TS_NODE *ts=<span class="literal">NULL</span>;</span><br><span class="line">    SI_DATABASE_VC_NODE *vc=<span class="literal">NULL</span>;</span><br><span class="line">    SI_DATABASE_SECTION *pmt=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> programNumber;</span><br><span class="line">    <span class="comment">//int dataLen, infoLen;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> secNo=<span class="number">0</span>,secNoLast=<span class="number">0</span>,ver;</span><br><span class="line"></span><br><span class="line">    SI_DB_BEGIN();</span><br><span class="line">    <span class="comment">//---- check length ----</span></span><br><span class="line">    <span class="keyword">if</span>(sectionLength &lt; <span class="number">16</span>)</span><br><span class="line">        SI_DB_RETURN(SI_ERR_SECTION_TOO_SHORT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((((<span class="keyword">unsigned</span> <span class="keyword">int</span>)sectionRawBuffer[<span class="number">1</span>]&amp;<span class="number">0x0F</span>)&lt;&lt;<span class="number">8</span>) + sectionRawBuffer[<span class="number">2</span>] + <span class="number">3</span> != sectionLength)</span><br><span class="line">        SI_DB_RETURN(SI_ERR_INVALIDSECTIONLENGTH);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(si_database_check_crc(sectionRawBuffer, sectionLength))</span><br><span class="line">        SI_DB_RETURN(SI_ERR_CRC_ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------</span></span><br><span class="line">    ts = pDatabase-&gt;currentTS;</span><br><span class="line">    SI_ASSERT(ts);</span><br><span class="line">    secNo=sectionRawBuffer[<span class="number">6</span>];</span><br><span class="line">    secNoLast=sectionRawBuffer[<span class="number">7</span>];</span><br><span class="line">    ver = (sectionRawBuffer[<span class="number">5</span>]&amp;<span class="number">0x3F</span>)&gt;&gt;<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get programNum and it's associated vc</span></span><br><span class="line">    SI_DB_GET_TABLEEXTENSION(sectionRawBuffer, programNumber);</span><br><span class="line">    SI_DB_GET_VCNODE_ADDR(ts, vc, programNumber);</span><br><span class="line">    <span class="keyword">if</span>(!vc)</span><br><span class="line">        SI_DB_RETURN(SI_ERR_CANNOTINSERT);</span><br><span class="line">    <span class="keyword">if</span>(vc-&gt;pmtPID == PID_NULL_PACKET || vc-&gt;pmtPID == <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        vc-&gt;pmtPID=pid;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (vc-&gt;pmtPID!=pid) {</span><br><span class="line">        SI_DB_RETURN(SI_ERR_CANNOTINSERT);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (secNo&gt;=SI_DB_SECTION_NUM_MAX || secNoLast&gt;=SI_DB_SECTION_NUM_MAX ||</span><br><span class="line">            secNo&gt;secNoLast) {</span><br><span class="line">        SI_DB_RETURN(SI_ERR_INVALIDSECTIONLENGTH);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((vc-&gt;pmt.count!=(secNoLast+<span class="number">1</span>)) ||</span><br><span class="line">            ((vc-&gt;pmt.ppSec!=<span class="literal">NULL</span>) &amp;&amp; (vc-&gt;pmt.ver != ver))) {</span><br><span class="line">        SI_Database_DestroyMultiSection(pDatabase,ts,&amp;vc-&gt;pmt,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(vc-&gt;pmt.ppSec==<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        SI_Database_CreateMultiSection(&amp;vc-&gt;pmt,secNoLast+<span class="number">1</span>,ver);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(vc-&gt;pmt.ppSec[secNo])</span><br><span class="line">    {</span><br><span class="line"></span><br><span class="line">        vc-&gt;gotPMT=SI_Database_Is_Got_Mulit_Section(&amp;vc-&gt;pmt);</span><br><span class="line">        <span class="keyword">if</span>(SI_DB_COMPARE_SECOBJ_AND_SECBUF(vc-&gt;pmt.ppSec[secNo], sectionRawBuffer, sectionLength)==<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span>(ait_update.pmt == pid &amp;&amp; ait_update.update)</span><br><span class="line">                <span class="keyword">goto</span> CHECK_AIT;</span><br><span class="line">            SI_DB_RETURN(SI_ERR_DATAALREADYEXIST);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            SI_Database_DestroyMultiSection(pDatabase,ts,&amp;vc-&gt;pmt,<span class="number">0</span>);</span><br><span class="line">            SI_Database_CreateMultiSection(&amp;vc-&gt;pmt,secNoLast+<span class="number">1</span>,ver);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    pmt=si_database_GEN_SECTION(pDatabase,ts, vc,sectionLength, sectionRawBuffer,<span class="number">0</span>);</span><br><span class="line">    vc-&gt;pmt.ppSec[secNo] = pmt;</span><br><span class="line">    vc-&gt;gotPMT=SI_Database_Is_Got_Mulit_Section(&amp;vc-&gt;pmt);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"vc-&gt;gotPMT=%d,pid=%d %s,%s,%d\n"</span>,vc-&gt;gotPMT,pid,__FILE__,__FUNCTION__,__LINE__);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\033[1;31m[vv] %s %d freq:%d, ver:%x sid %x\033[m\n"</span>,__FUNCTION__,__LINE__,ts-&gt;frequency,ver,</span><br><span class="line">           programNumber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//vc-&gt;pmt = pmt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1<span class="comment">//def ENABLE_NEW_DVB</span></span></span><br><span class="line">    vc-&gt;PMTParsed=FALSE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    SI_DB_RETURN(SI_ERR_OK);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>到si_database_GEN_SECTION这里就算是组段完成了（具体细节没有去看了）？然后vc-&gt;gotPMT被置TRUE认为拿到了<code>PMT</code>。</p>
<p>整理一下_SDEC_Thread线程创建：</p>
<blockquote>
<p>TVservice</p>
<blockquote>
<p>Initial</p>
<blockquote>
<p>RegisterInitFunc</p>
<blockquote>
<p>InitDTV</p>
<blockquote>
<p>HalModulesInit</p>
<blockquote>
<p>RHAL_SDEC_InitializeModule</p>
<blockquote>
<p>_Initiallize</p>
<blockquote>
<p>_SDEC_Thread</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>执行：</p>
<blockquote>
<p>_SDEC_Thread</p>
<blockquote>
<p>fnSDECDataHandlingCB</p>
<blockquote>
<p>si_collector_copy_section</p>
<blockquote>
<p>SI_Database_InsertSection</p>
<blockquote>
<p>si_database_insert_pat</p>
<p>si_database_insert_pmt</p>
<blockquote>
<p>si_database_GEN_SECTION</p>
<p>SI_Database_Is_Got_Mulit_Section</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p><strong>总结</strong></p>
<p>不要忘了si_agent_threadfuntion线程，重新整理下：</p>
<blockquote>
<p>si_agent_threadfuntion</p>
<blockquote>
<p>SI_Agent_CollectSection</p>
<blockquote>
<p>SiAgtIF_Run</p>
<blockquote>
<p>SiAgentObj_ExecMainTaskSM</p>
<blockquote>
<p>SiAgent_UpdateFilterTaskState</p>
<blockquote>
<p>SiAgent_FTE_CheckTableReceive</p>
<blockquote>
<p>SiAgtFW_CheckPatReceive</p>
<p>SiAgtFW_CheckPmtReceive</p>
<blockquote>
<p>SI_Database_GetSectionReceiveFlag</p>
</blockquote>
</blockquote>
</blockquote>
<p>SiAgent_SM_Main_ScanCh</p>
<blockquote>
<p>SiAgent_GenScanChGetPatFtp</p>
<p>SiAgent_GenScanChGetTablesFtp</p>
<p>SI_Callback_ScanChannel</p>
<blockquote>
<p>SI_Channel_UpdateChList_Append</p>
<blockquote>
<p>si_channel_get_update_ch_list_in_ts</p>
<blockquote>
<p>si_channel_new_channel_object</p>
<blockquote>
<p>si_channel_fill_ch</p>
<blockquote>
<p>SI_Database_GetChannelInfo</p>
<blockquote>
<p>si_database_get_logical_num_and_onid</p>
<blockquote>
<p>__si_database_get_logical_num_and_onid</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>SiAgent_ExecuteFilterTask</p>
<blockquote>
<p>SiAgent_FTE_EnableSecFilter</p>
<blockquote>
<p>SiAgent_Enable_GetTableFilter</p>
<p>SiAgent_Enable_GetPmtFilter</p>
<blockquote>
<p>SiAgent_VSFM_CreatePidLayer</p>
<blockquote>
<p>SiAgtFW_EnablePidFilter</p>
<blockquote>
<p>SI_TPInterface_SetFilter</p>
<blockquote>
<p>SI_BeanGen_EnablePid</p>
<blockquote>
<p>RHAL_SDEC_RequestSection</p>
<blockquote>
<p>fnSDECDataHandlingCB</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>SI_Collector_CollectSection</p>
<blockquote>
<p>SI_TPInterface_GetBeanQueue</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<p>在扫台线程ScanThread Check SI，也就是si_agent_threadfuntion SI Agent Running阶段，注册fnSDECDataHandlingCB回调函数，_SDEC_Thread线程在Section来临时，执行这个回调函数，做组段动作，并拿数据和置位相应的状态位，si_agent_threadfuntion 根据这些状态位再更新FilterTaskState，判断扫台成功，再回调SI_Callback_ScanChannel发消息告诉ScanThread线程Check SI成功。</p>
<p>有点多，有点乱，这只是个大概，还有一些Bean、TaskPool的设计和实现细节需要理解。我不理解，我都是瞎写的。<span class="github-emoji"><span>😅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/tv/" rel="tag"># tv</a>
              <a href="/tags/dvb/" rel="tag"># dvb</a>
              <a href="/tags/si/" rel="tag"># si</a>
              <a href="/tags/2851/" rel="tag"># 2851</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/09/16/scan/" rel="prev" title="扫台">
                  <i class="fa fa-chevron-left"></i> 扫台
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ylab324</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.5.0/pjax.min.js" integrity="sha256-3NkoLDrmHLTYj7csHIZSr0MHAFTXth7Ua/DDt4MRUAg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/pjax.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>




  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"ylab324","count":false,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/Gantzert_Felixander.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"react":{"opacity":0.9},"log":false});</script></body>
</html>
